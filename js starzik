let canvas, ctx, currentScene, inventory, gameState, scenes;
let dialogVisible = false;
let currentDialogOptions = null;

const itemIcons = {
  Åopatka: "â›ï¸",
  KoÅ›Ä‡: "ğŸ¦´",
  "DowÃ³d osobisty": "ğŸªª",
  "MaÅ‚y kluczyk": "ğŸ”‘", // NOWE
  List: "âœ‰ï¸",
  "Stary klucz": "ğŸ—ï¸",
  PamiÄ™tnik: "ğŸ“”",
  "Kartka z kodem": "ğŸ“œ",
  "Stara fotografia": "ğŸ“·",
  "Stare monety": "ğŸª™",
  Dokumenty: "ğŸ“‹",
  Bezpiecznik: "ğŸ”Œ",
  "MaÅ‚y klucz do szafki": "ğŸ—ï¸",
  "Notes z telefonami": "ğŸ“",
  "Kartka z sejfu": "ğŸ“",
  Walizka: "ğŸ’¼"
};

function log(message) {
  console.log(message);
  document.getElementById("debug").textContent = message;
}

function checkIntercomCodeDirect(code) {
  hideCodeInput();

  if (code === "8802") {
    gameState.intercomUnlocked = true;

    // DODAJ DÅ¹WIÄ˜K OTWIERANIA DRZWI
    const doorSound = new Audio("https://files.catbox.moe/flpfyi.mp3");
    doorSound.volume = 0.8;
    doorSound
      .play()
      .then(() => console.log("âœ… DÅºwiÄ™k drzwi odtworzony"))
      .catch((e) => console.log("âŒ Nie moÅ¼na odtworzyÄ‡ dÅºwiÄ™ku drzwi:", e));

    showDialog("Domofon wydaje dÅºwiÄ™k i drzwi siÄ™ otwierajÄ…!");
  } else {
    showDialog("NieprawidÅ‚owy kod do domofonu.");
  }
}
// PRELOAD OBRAZÃ“W
const preloadImages = {
  courtyard: new Image(),
  courtyardOpen: new Image(),
  apartment: new Image(),
  keyWithCode: new Image(),
  letter: new Image(),
  staircase: new Image(),
  hiddenPicture: new Image(),
  safe: new Image(),
  tvScreen: new Image(),
  suitcase: new Image()
};

preloadImages.courtyard.src = "https://i.imgur.com/o0r1Gow.png";
preloadImages.courtyardOpen.src = "https://i.imgur.com/JQgnss8.png";
preloadImages.apartment.src = "https://i.imgur.com/CcmvRTN.jpeg";
preloadImages.keyWithCode.src = "https://i.imgur.com/RlK3rAq.png";
preloadImages.letter.src = "https://i.imgur.com/WpYLQLB.png";
preloadImages.staircase.src = "https://i.imgur.com/7HN1h8Z.png";
preloadImages.hiddenPicture.src = "https://i.imgur.com/IDnZ13x.png";
preloadImages.safe.src = "https://i.imgur.com/u3pO09J.png";
preloadImages.tvScreen.src = "https://i.imgur.com/Xi3zXIA.png";
preloadImages.suitcase.src = "https://i.imgur.com/gT3o9yo.png";

// Zacznij Å‚adowanie od razu
preloadImages.courtyard.onload = () => console.log("PodwÃ³rko zaÅ‚adowane!");
preloadImages.apartment.onload = () => console.log("Mieszkanie zaÅ‚adowane!");
function initGame() {
  try {
    canvas = document.getElementById("canvas");
    if (!canvas) {
      console.error("Canvas element not found!");
      return false;
    }

    ctx = canvas.getContext("2d");
    if (!ctx) {
      console.error("Cannot get 2D context!");
      return false;
    }

    currentScene = "menu";
    inventory = [];
    gameState = {
      hasSpade: false,
      hasBone: false,
      boneVisible: false,
      gaveBone: false,
      gotInfoFromKowalski: false, // NOWE - czy rozmawiaÅ‚ z Kowalskim po koÅ›ci
      askedAboutWindows: false, // NOWE - czy pytaÅ‚ sprzÄ…taczkÄ™ o okna
      wellOpened: false,
      hasID: false,
      hasSmallKey: false, // NOWE - maÅ‚y kluczyk z kratki
      gotLetter: false,
      askedAboutIntercomCode: false, // NOWE - czy pytaÅ‚ o kod do domofonu
      readLetter: false,
      canEnter: false,
      intercomUnlocked: false,
      fuseBoxSolved: false,
      foundSafeCard: false,
      safeOpened: false,
      tvTurnedOn: false,
      suitcaseFound: false,
      tvScreenOn: false,
      cabinetOpened: false
    };

    scenes = {
      menu: new MenuScene(),
      courtyard: new CourtyardScene(),
      staircase: new StaircaseScene(),
      apartment: new ApartmentScene(),
      ending: new EndingScene()
    };

    canvas.addEventListener("click", handleClick);
    canvas.addEventListener("mousemove", handleMouseMove);

    console.log("Game initialized successfully!");
    gameLoop();
    return true;
  } catch (error) {
    console.error("Error initializing game:", error);
    log("âŒ BÅ‚Ä…d inicjalizacji: " + error.message);
    return false;
  }
}

function handleClick(e) {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const codeInput = document.getElementById("codeInput");
  if (codeInput.style.display === "block") {
    return;
  }

  if (dialogVisible) {
    return;
  }
  // URUCHOM MUZYKÄ˜ TÅA po klikniÄ™ciu
  if (scenes[currentScene] && scenes[currentScene].startMusic) {
    scenes[currentScene].startMusic();
  }
  scenes[currentScene].click(x, y);
}

function handleMouseMove(e) {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  scenes[currentScene].hover(x, y);
}

function showDialog(text, duration = 0) {
  const dialogEl = document.getElementById("dialog");

  const dialogContent = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
      <div style="flex: 1; padding-right: 10px;">${text}</div>
      <button onclick="hideDialog()" style="width: 25px; height: 25px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; flex-shrink: 0;">Ã—</button>
    </div>
  `;

  dialogEl.innerHTML = dialogContent;
  dialogEl.style.display = "block";
  dialogVisible = true;

  if (duration > 0) {
    setTimeout(() => {
      hideDialog();
    }, duration);
  }
}

function showDialogWithOptions(text, options, npcName = "") {
  currentDialogOptions = options;
  let html = "";
  if (npcName) {
    html += `<div style="background: rgba(100,100,100,0.8); padding: 5px 10px; margin-bottom: 10px; border-radius: 4px; font-weight: bold; color: #fff; font-size: 12px;">${npcName}</div>`;
  }
  html += `<div>${text}</div><div style="margin-top: 10px;">`;
  options.forEach((option, index) => {
    html += `<div class="dialog-option" onclick="selectOption(${index})">${option.text}</div>`;
  });

  if (
    options.length > 0 &&
    !options.some(
      (opt) =>
        opt.text.includes("MiÅ‚ego") ||
        opt.text.includes("DziÄ™kujÄ™") ||
        opt.text.includes("Pa") ||
        opt.text.includes("ZakoÅ„cz")
    )
  ) {
    html += `<div class="dialog-option" onclick="hideDialog()" style="background: rgba(80,80,80,0.3); margin-top: 8px;">â† ZakoÅ„cz rozmowÄ™</div>`;
  }

  html += "</div>";

  const dialogEl = document.getElementById("dialog");
  dialogEl.innerHTML = html;
  dialogEl.style.display = "block";
  dialogVisible = true;
}

function selectOption(index) {
  if (currentDialogOptions && currentDialogOptions[index]) {
    const option = currentDialogOptions[index];
    if (option.action) {
      setTimeout(() => {
        option.action();
      }, 100);
    }
  }
}

function hideDialog() {
  document.getElementById("dialog").style.display = "none";
  dialogVisible = false;
  currentDialogOptions = null;
}

function addItem(item) {
  if (!inventory.includes(item)) {
    inventory.push(item);
    updateInventoryDisplay();
  }
}

function removeItem(item) {
  const index = inventory.indexOf(item);
  if (index > -1) {
    inventory.splice(index, 1);
    updateInventoryDisplay();
  }
}

function hasItem(item) {
  return inventory.includes(item);
}

function updateInventoryDisplay() {
  const slots = document.querySelectorAll(".inventory-slot");
  slots.forEach((slot, index) => {
    slot.textContent = "";
    slot.className = "inventory-slot empty";
    slot.title = "";
    slot.onclick = null;
  });

  inventory.forEach((item, index) => {
    if (index < slots.length) {
      const slot = slots[index];
      slot.textContent = itemIcons[item] || "â“";
      slot.className = "inventory-slot";
      slot.title = item;
      slot.onclick = () => useItem(item);
    }
  });
}

function useItem(item) {
  if (item === "List") {
    showLetterContent();
  } else if (item === "MaÅ‚y kluczyk") {
    if (gameState.askedAboutIntercomCode) {
      showKeyWithCode();
    } else {
      showDialog("To maÅ‚y kluczyk. MoÅ¼e ktoÅ› wie, do czego sÅ‚uÅ¼y?", 2000);
    }
  } else if (item === "PamiÄ™tnik") {
    showDiaryWithHint();
  } else if (item === "Notes z telefonami") {
    showPhoneNotes();
  } else if (item === "Kartka z sejfu") {
    showSafeCard();
  } else if (item === "Walizka") {
    showSuitcaseEnding();
  } else if (item === "Kartka z kodem") {
    showCodeCard();
  } else if (item === "Stara fotografia") {
    showOldPhoto();
  } else if (item === "Dokumenty") {
    showDocuments();
  } else {
    showDialog(
      `Masz przedmiot: ${item}. MoÅ¼e przydaÄ‡ siÄ™ gdzie indziej?`,
      2000
    );
  }
}
function showCodeCard() {
  const cardContent = `
    <div style="background: #f5f5dc; color: #333; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b7355;">
      <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">
        ğŸ“œ UKRYTA KARTKA ğŸ“œ
      </div>
      <div style="text-align: center; margin: 20px 0;">
        <div style="font-size: 32px; font-weight: bold; color: #8b4513; background: #fffaf0; padding: 15px; border: 1px dashed #8b7355; border-radius: 5px;">
          2710
        </div>
      </div>
      <div style="font-style: italic; text-align: center; margin-top: 15px; color: #666;">
        "27 paÅºdziernika - dzieÅ„ kiedy wszystko siÄ™ zmieniÅ‚o"
      </div>
    </div>
    <div style="text-align: center; margin-top: 10px;">
      <button onclick="hideDialog()" style="padding: 8px 16px; background: #8b4513; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
        Zamknij kartkÄ™
      </button>
    </div>
  `;
  showDialog(cardContent, 0);
}

function showDiary() {
  const diaryContent = `
    <div style="background: #2f1b14; color: #d4af37; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b4513;">
      <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">
        ğŸ“” PAMIÄ˜TNIK STARZIKA - 1969 ğŸ“”
      </div>
      <div style="background: #1a0f0a; padding: 15px; border-radius: 5px; font-family: serif; line-height: 1.6;">
        <p><strong>27 paÅºdziernika 1969</strong></p>
        <p style="margin: 10px 0;">"DziÅ› Maria powiedziaÅ‚a mi waÅ¼nÄ… wiadomoÅ›Ä‡. ZostanÄ™ ojcem! To najszczÄ™Å›liwszy dzieÅ„ w moim Å¼yciu."</p>
        <p style="margin: 10px 0;">"SchowaÅ‚em nasze najwaÅ¼niejsze dokumenty w bezpiecznym miejscu. Numer tego dnia - 2710 - bÄ™dzie moim kodem. Nigdy tego nie zapomnÄ™."</p>
        <p style="margin: 10px 0; font-style: italic;">"Dla przyszÅ‚ych pokoleÅ„..."</p>
      </div>
    </div>
    <div style="text-align: center; margin-top: 10px;">
      <button onclick="hideDialog()" style="padding: 8px 16px; background: #8b4513; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
        Zamknij pamiÄ™tnik
      </button>
    </div>
  `;
  showDialog(diaryContent, 0);
}

function showOldPhoto() {
  const photoContent = `
    <div style="background: #f0f0f0; color: #333; padding: 20px; border-radius: 8px; margin: 10px 0; border: 3px solid #666;">
      <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">
        ğŸ“· STARA FOTOGRAFIA ğŸ“·
      </div>
      <div style="background: #fff; padding: 15px; border: 1px solid #ccc; text-align: center;">
        <div style="font-size: 60px; margin: 20px 0;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
        <p style="margin: 10px 0;"><strong>Rodzina DyÅ‚ka - 1975</strong></p>
        <p style="margin: 10px 0;">Na tle budynku przy Cmentarnej 5</p>
        <p style="font-style: italic; color: #666;">JÃ³zef, Maria i maÅ‚y Tomek</p>
      </div>
    </div>
    <div style="text-align: center; margin-top: 10px;">
      <button onclick="hideDialog()" style="padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
        Zamknij zdjÄ™cie
      </button>
    </div>
  `;
  showDialog(photoContent, 0);
}

function showDocuments() {
  const documentsContent = `
    <div style="background: #fffef7; color: #333; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b4513;">
      <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">
        ğŸ“‹ WAÅ»NE DOKUMENTY ğŸ“‹
      </div>
      <div style="background: #fff; padding: 15px; border: 1px solid #ccc;">
        <h4>TESTAMENT JÃ“ZEFA DYÅKI</h4>
        <p style="margin: 10px 0;"><strong>Data:</strong> 15 paÅºdziernika 2013</p>
        <p style="margin: 10px 0;">Mieszkanie przy ul. Cmentarnej 5 przekazujÄ™ mojemu synowi Tomkowi.</p>
        <p style="margin: 10px 0;">Wszystkie pamiÄ…tki rodzinne majÄ… pozostaÄ‡ w rodzinie.</p>
        <hr style="margin: 15px 0;">
        <h4>AKT WÅASNOÅšCI</h4>
        <p style="margin: 10px 0;">Mieszkanie nr 12, budynek Cmentarna 5</p>
        <p style="margin: 10px 0;">WÅ‚aÅ›ciciel: JÃ³zef DyÅ‚ka</p>
      </div>
    </div>
    <div style="text-align: center; margin-top: 10px;">
      <button onclick="hideDialog()" style="padding: 8px 16px; background: #8b4513; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
        Zamknij dokumenty
      </button>
    </div>
  `;
  showDialog(documentsContent, 0);
}
function showLetterContent() {
  gameState.readLetter = true; // Ustaw flagÄ™, Å¼e list zostaÅ‚ przeczytany

  const letterContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <img src="https://i.imgur.com/WpYLQLB.png" style="max-width: 90vw; max-height: 80vh; display: block;" alt="List od ZarzÄ…du Budynku">
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="hideDialog()" style="padding: 10px 20px; background: #d4af37; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ZAMKNIJ
        </button>
      </div>
    </div>
  `;
  showDialog(letterContent, 0);
}
function showKeyWithCode() {
  const keyContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <img src="https://i.imgur.com/RlK3rAq.png" style="max-width: 90vw; max-height: 80vh; display: block;" alt="Kluczyk z kodem">
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="hideDialog()" style="padding: 10px 20px; background: #d4af37; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ZAMKNIJ
        </button>
      </div>
    </div>
  `;
  showDialog(keyContent, 0);
  gameState.readLetter = true;
}
function showCodeInput() {
  hideDialog();
  document.getElementById("codeInput").style.display = "block";
  document.getElementById("codeInput").dataset.type = "sewer";
  document.getElementById("codeInput").querySelector("h3").textContent =
    "WprowadÅº kod do kÅ‚Ã³dki:";
  if (gameState.gotCode) {
    document.getElementById("codeInput").querySelector("h3").textContent =
      "WprowadÅº kod do kÅ‚Ã³dki:\nWskazÃ³wka: tuÅ¼ po wojnie, miaÅ‚a 22 lata...";
  }
}

function hideCodeInput() {
  document.getElementById("codeInput").style.display = "none";
  document.getElementById("codeField").value = "";
  delete document.getElementById("codeInput").dataset.type;
}

function checkCode() {
  const code = document.getElementById("codeField").value;
  if (document.getElementById("codeInput").dataset.type === "intercom") {
    checkIntercomCodeDirect(code);
  } else {
    checkCodeDirect(code);
  }
}

function showIntercomKeypad() {
  hideDialog();
  document.getElementById("codeInput").style.display = "block";
  document.getElementById("codeInput").dataset.type = "intercom";
  const heading = document.getElementById("codeInput").querySelector("h3");
  heading.textContent = "WprowadÅº kod do domofonu:";
}

function checkCodeDirect(code) {
  hideCodeInput();

  if (code === "324") {
    gameState.wellOpened = true;
    addItem("DowÃ³d osobisty");
    addItem("MaÅ‚y kluczyk");
    gameState.hasID = true;
    gameState.hasSmallKey = true;
    showDialog(
      "UdaÅ‚o siÄ™! Kratka kanalizacyjna siÄ™ otworzyÅ‚a! W Å›rodku byÅ‚ TwÃ³j stary dowÃ³d osobisty i maÅ‚y kluczyk.",
      4000
    );
  } else {
    showDialog("NieprawidÅ‚owy kod. MoÅ¼e potrzebujesz wiÄ™cej wskazÃ³wek?");
  }
}

function changeScene(sceneName) {
  currentScene = sceneName;
  hideDialog();

  // Zatrzymaj wszystkie muzyki
  Object.values(scenes).forEach((scene) => {
    if (scene.backgroundMusic) {
      scene.backgroundMusic.pause();
    }
  });
  // DODAJ RESET KARTKI PRZY POWROCIE DO MENU:
  if (sceneName === "menu" && scenes.menu) {
    scenes.menu.introPaper.visible = false;
    scenes.menu.introPaper.animation = 0;
    scenes.menu.introPaper.showButton = false;
    // PrzywrÃ³Ä‡ obszary klikniÄ™cia przyciskÃ³w
    scenes.menu.clickAreas = [];
    scenes.menu.addArea(0, 0, 800, 600, () => scenes.menu.startMusic());
    scenes.menu.addArea(300, 300, 200, 50, () => scenes.menu.showIntroPaper());
    scenes.menu.addArea(300, 370, 200, 50, () =>
      showDialog(
        "KrÃ³tka gra przygodowa - prequel escape roomu Familock w ÅšwiÄ™tochÅ‚owicach.",
        2000
      )
    );
    scenes.menu.addArea(300, 440, 200, 50, () => {
      showDialog("Przekierowywanie do Familock...", 2000);
      setTimeout(() => window.open("https://www.familock.pl", "_blank"), 1000);
    });
    scenes.menu.addArea(650, 520, 120, 40, () =>
      scenes.menu.toggleFullscreen()
    );
  }
  // PokaÅ¼ ekwipunek gdy gra siÄ™ rozpoczyna
  if (sceneName === "courtyard") {
    document.getElementById("inventoryGrid").parentElement.style.display =
      "block";
    updateFullscreenIcon();
  }
}
function showDiaryWithHint() {
  const diaryContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <div style="background: #2f1b14; color: #d4af37; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b4513;">
        <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">ğŸ“” PAMIÄ˜TNIK DZIADKA - 1969 ğŸ“”</div>
        <div style="background: #1a0f0a; padding: 15px; border-radius: 5px; font-family: serif; line-height: 1.6;">
          <p><strong>27 paÅºdziernika 1969</strong></p>
          <p style="margin: 10px 0;">"DziÅ› Maria powiedziaÅ‚a mi waÅ¼nÄ… wiadomoÅ›Ä‡. ZostanÄ™ ojcem! To najszczÄ™Å›liwszy dzieÅ„ w moim Å¼yciu."</p>
          <p style="margin: 10px 0;">"SchowaÅ‚em nasze najwaÅ¼niejsze dokumenty w bezpiecznym miejscu. Numer tego dnia - 2710 - bÄ™dzie moim kodem."</p>
          <p style="margin: 10px 0; font-style: italic; color: #ffff99;">"MoÅ¼e powinienem zerknÄ…Ä‡ za stary obraz na Å›cianie..."</p>
        </div>
      </div>
    </div>
  `;
  showDialog(diaryContent, 0);
}

function showPhoneNotes() {
  const notesContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <div style="background: #f5f5dc; color: #333; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b7355;">
        <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">ğŸ“ NOTES Z TELEFONAMI ğŸ“</div>
        <div style="background: #fff; padding: 15px; border-radius: 5px; font-family: monospace;">
          <p><strong>I.</strong> 322452833</p>
          <p><strong>II.</strong> 322409123</p>
          <p><strong>III.</strong> 322453320</p>
          <p><strong>IV.</strong> 322451782</p>
          <p><strong>V.</strong> 322487524</p>
        </div>
        <div style="margin-top: 10px; font-style: italic; text-align: center; color: #666;">
          Stare numery telefonÃ³w z lat 80-tych
        </div>
      </div>
    </div>
  `;
  showDialog(notesContent, 0);
}

function showSafeCard() {
  const cardContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <div style="background: #f5f5dc; color: #333; padding: 20px; border-radius: 8px; margin: 10px 0; border: 2px solid #8b7355;">
        <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px;">ğŸ“ KARTKA Z SEJFU ğŸ“</div>
        <div style="text-align: center; margin: 20px 0; font-size: 24px; font-weight: bold; color: #8b4513;">
          "NajwiÄ™kszy skarb znajdziesz<br/>pod starÄ… kanapÄ…..."
        </div>
        <div style="font-style: italic; text-align: center; margin-top: 15px; color: #666;">
          Poszukaj pod kanapÄ… w salonie
        </div>
      </div>
    </div>
  `;
  showDialog(cardContent, 0);
}

function showSuitcaseEnding() {
  // DODAJ DÅ¹WIÄ˜K KOÅƒCOWY
  const endingSound = new Audio("https://files.catbox.moe/42b7zp.mp3");
  endingSound.volume = 0.8;
  endingSound
    .play()
    .then(() => console.log("âœ… DÅºwiÄ™k koÅ„cowy odtworzony"))
    .catch((e) => console.log("âŒ Nie moÅ¼na odtworzyÄ‡ dÅºwiÄ™ku koÅ„cowego:", e));

  const endingContent = `
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(20, 22, 34, 0.95); z-index: 10001; display: flex; align-items: center; justify-content: center;">
      <div style="background: #F5F1E8; color: #2C1810; padding: 40px; border-radius: 10px; border: 2px solid #D4C4A8; text-align: center; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); position: relative;">
        
        <div style="position: absolute; top: 20px; left: 30px; width: 60px; height: 30px; background: rgba(232, 212, 176, 0.3); border-radius: 50%; transform: rotate(15deg);"></div>
        <div style="position: absolute; bottom: 40px; right: 20px; width: 50px; height: 25px; background: rgba(232, 212, 176, 0.3); border-radius: 50%; transform: rotate(-10deg);"></div>
        
        <div style="font-size: 24px; margin-bottom: 20px; font-weight: bold; font-family: serif; color: #2C1810;">
          GRATULACJE!
        </div>
        
        <div style="width: 80%; height: 1px; background: #8B4513; margin: 0 auto 20px auto;"></div>
        
        <div style="font-size: 16px; margin: 25px 0; line-height: 1.8; font-family: serif;">
          Nikt nie wie, co znajduje siÄ™ w walizce...<br/><br/>
          Chcecie odkryÄ‡ jej tajemnicÄ™?<br/><br/>
          <strong>PrzyjdÅºcie sprawdziÄ‡ do Familocka<br/>
          w ÅšwiÄ™tochÅ‚owicach przy ulicy Cmentarnej 5!</strong>
        </div>
        
        <div style="margin-top: 30px;">
          <button onclick="window.open('https://www.familock.pl', '_blank')" style="padding: 12px 20px; background: #2d3748; color: #fff; border: 2px solid #4a5568; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; font-family: serif;">
            WWW.FAMILOCK.PL
          </button>
          <button onclick="showCreditsScreen()" style="padding: 12px 20px; background: #8b4513; color: #fff; border: 2px solid #5d2f0a; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; font-family: serif;">
            TWÃ“RCY GRY
          </button>
        </div>
      </div>
    </div>
  `;
  showDialog(endingContent, 0);
}
class Scene {
  constructor() {
    this.clickAreas = [];
    this.hoveredArea = null;
  }

  addArea(x, y, w, h, action) {
    this.clickAreas.push({ x, y, w, h, action });
  }

  click(x, y) {
    for (let area of this.clickAreas) {
      if (
        x >= area.x &&
        x <= area.x + area.w &&
        y >= area.y &&
        y <= area.y + area.h
      ) {
        area.action();
        break;
      }
    }
  }

  hover(x, y) {
    let found = false;
    for (let area of this.clickAreas) {
      if (
        x >= area.x &&
        x <= area.x + area.w &&
        y >= area.y &&
        y <= area.y + area.h
      ) {
        this.hoveredArea = area;
        canvas.style.cursor = "pointer";
        found = true;
        break;
      }
    }
    if (!found) {
      this.hoveredArea = null;
      canvas.style.cursor = "crosshair";
    }
  }
}

// Dodaj to do klasy MenuScene w konstruktorze:

class MenuScene extends Scene {
  constructor() {
    super();
    this.animation = 0;
    this.backgroundMusic = new Audio("https://files.catbox.moe/ngqi9t.mp3");
    this.backgroundMusic.loop = true;
    this.backgroundMusic.volume = 0.3;
    this.musicStarted = false;
    this.paperSound = new Audio("https://files.catbox.moe/h99gh2.mp3");
    this.paperSound.volume = 1;
    // DRUGI DÅ¹WIÄ˜K - NOWY
    this.secondSound = new Audio("https://files.catbox.moe/qoxae0.mp3");
    this.secondSound.volume = 0.8;

    // NOWY SYSTEM DESZCZU
    this.rainDrops = [];
    this.initRain();
    // DÅºwiÄ™k ksiÄ™Å¼yca
    this.moonSound = new Audio("https://files.catbox.moe/q9a53b.mp3");
    this.moonSound.volume = 0.7;

    // SYSTEM BÅYSKAWIC
    this.lightning = {
      active: false,
      intensity: 0,
      timer: 0,
      nextStrike: this.getRandomLightningTime(),
      duration: 0,
      branches: []
    };

    // NOWY SYSTEM KARTKI WPROWADZAJÄ„CEJ
    this.introPaper = {
      visible: false,
      animation: 0,
      maxAnimation: 60,
      text:
        "Rok 1988.\nStarzik JÃ³zef niespodziewanie pojawia siÄ™\nprzed familokiem przy ulicy Cmentarnej 5.\nCo ...lub kto go tutaj sprowadziÅ‚ i jakie sÄ… jego dalsze plany?",
      scale: 0,
      rotation: 0,
      opacity: 0,
      showButton: false,
      secondSoundPlayed: false
    };

    // Obszar klikniÄ™cia na caÅ‚e menu do uruchomienia muzyki
    this.addArea(0, 0, 800, 600, () => this.startMusic());

    // ZMIANA: Przycisk teraz pokazuje kartkÄ™ zamiast od razu iÅ›Ä‡ do gry
    this.addArea(300, 300, 200, 50, () => this.showIntroPaper());
    this.addArea(300, 370, 200, 50, () =>
      showDialog(
        "KrÃ³tka gra przygodowa - prequel escape roomu Familock w ÅšwiÄ™tochÅ‚owicach.",
        2000
      )
    );
    this.addArea(300, 440, 200, 50, () => {
      showDialog("Przekierowywanie do Familock...", 2000);
      setTimeout(() => window.open("https://www.familock.pl", "_blank"), 1000);
    });
  }

  // NOWA METODA - przeÅ‚Ä…czanie peÅ‚nego ekranu
  toggleFullscreen() {
    try {
      if (!document.fullscreenElement) {
        // WejdÅº w peÅ‚ny ekran
        const gameContainer =
          document.querySelector(".game-container") || document.body;
        if (gameContainer.requestFullscreen) {
          gameContainer.requestFullscreen();
        } else if (gameContainer.webkitRequestFullscreen) {
          gameContainer.webkitRequestFullscreen();
        } else if (gameContainer.msRequestFullscreen) {
          gameContainer.msRequestFullscreen();
        }
        showDialog(
          "Gra uruchomiona na peÅ‚nym ekranie! NaciÅ›nij ESC aby wyjÅ›Ä‡.",
          3000
        );
      } else {
        // WyjdÅº z peÅ‚nego ekranu
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        showDialog("WyszedÅ‚eÅ› z peÅ‚nego ekranu.", 2000);
      }
    } catch (error) {
      showDialog("PrzeglÄ…darka nie obsÅ‚uguje peÅ‚nego ekranu.");
      console.log("Fullscreen error:", error);
    }
  }
  showIntroPaper() {
    console.log("ğŸ“„ PokazujÄ™ kartkÄ™ wprowadzajÄ…cÄ…...");

    // OdtwÃ³rz pierwszy dÅºwiÄ™k (kartka)
    this.paperSound
      .play()
      .then(() => console.log("âœ… Pierwszy dÅºwiÄ™k (kartka) odtworzony"))
      .catch((e) => console.log("âŒ Nie moÅ¼na odtworzyÄ‡ dÅºwiÄ™ku kartki:", e));

    this.introPaper.visible = true;
    this.introPaper.animation = 0;
    this.introPaper.showButton = false;
    this.introPaper.secondSoundPlayed = false;

    // USUÅƒ WSZYSTKIE obszary klikniÄ™cia przyciskÃ³w
    this.clickAreas = this.clickAreas.filter((area) => {
      return area.x === 0 && area.y === 0 && area.w === 800 && area.h === 600;
    });

    // Zaplanuj odtworzenie drugiego dÅºwiÄ™ku po 2.5 sekundach
    setTimeout(() => {
      console.log("ğŸµ Odtwarzam drugi dÅºwiÄ™k...");

      this.secondSound
        .play()
        .then(() => {
          console.log("âœ… Drugi dÅºwiÄ™k odtworzony!");
          this.introPaper.secondSoundPlayed = true;

          // PokaÅ¼ przycisk po kolejnej sekundzie
          setTimeout(() => {
            this.introPaper.showButton = true;
            this.addArea(350, 400, 100, 40, () => changeScene("courtyard"));
          }, 1000);
        })
        .catch((e) => console.log("âŒ Drugi dÅºwiÄ™k failed:", e));
    }, 2500);
  }

  // NOWA METODA - aktualizacja animacji kartki
  updateIntroPaper() {
    if (!this.introPaper.visible) return;

    if (this.introPaper.animation < this.introPaper.maxAnimation) {
      this.introPaper.animation++;

      // Easing function dla pÅ‚ynnej animacji
      const progress = this.introPaper.animation / this.introPaper.maxAnimation;
      const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

      this.introPaper.scale = eased;
      this.introPaper.opacity = eased;
      this.introPaper.rotation = (1 - eased) * 0.3; // Lekka rotacja na poczÄ…tku
    }
  }

  // NOWA METODA - rysowanie kartki wprowadzajÄ…cej
  drawIntroPaper() {
    if (!this.introPaper.visible || this.introPaper.opacity <= 0) return;

    ctx.save();

    // PÃ³Å‚przezroczyste tÅ‚o
    ctx.globalAlpha = this.introPaper.opacity * 0.8;
    ctx.fillStyle = "rgba(20, 22, 34, 0.7)";
    ctx.fillRect(0, 0, 800, 600);

    // Transformacje kartki
    ctx.translate(400, 300); // Åšrodek ekranu
    ctx.rotate(this.introPaper.rotation);
    ctx.scale(this.introPaper.scale, this.introPaper.scale);
    ctx.globalAlpha = this.introPaper.opacity;

    // CieÅ„ kartki
    ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
    ctx.shadowBlur = 20;
    ctx.shadowOffsetX = 8;
    ctx.shadowOffsetY = 8;

    // TÅ‚o kartki - stary papier
    ctx.fillStyle = "#F5F1E8";
    ctx.fillRect(-200, -150, 400, 300);

    // Obramowanie kartki
    ctx.strokeStyle = "#D4C4A8";
    ctx.lineWidth = 2;
    ctx.strokeRect(-200, -150, 400, 300);

    // Plamy na papierze (efekt starzenia)
    ctx.globalAlpha = this.introPaper.opacity * 0.3;
    ctx.fillStyle = "#E8D4B0";
    ctx.beginPath();
    ctx.ellipse(-120, -80, 30, 15, 0.3, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(150, 100, 25, 12, -0.2, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(-80, 120, 20, 10, 0.5, 0, 2 * Math.PI);
    ctx.fill();

    ctx.globalAlpha = this.introPaper.opacity;

    // Reset cienia dla tekstu
    ctx.shadowColor = "transparent";
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    // TytuÅ‚ na kartce
    ctx.fillStyle = "#2C1810";
    ctx.font = "bold 24px serif";
    ctx.textAlign = "center";
    ctx.fillText("STARZIK: PREQUEL", 0, -100);

    // Linia pod tytuÅ‚em
    ctx.strokeStyle = "#8B4513";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(-80, -85);
    ctx.lineTo(80, -85);
    ctx.stroke();

    // Tekst gÅ‚Ã³wny (podzielony na linie)
    ctx.font = "14px serif";
    ctx.fillStyle = "#2C1810";
    ctx.textAlign = "center";

    const lines = this.introPaper.text.split("\n");
    lines.forEach((line, index) => {
      ctx.fillText(line, 0, -50 + index * 20);
    });

    // Przycisk "DO GRY" (pokazuje siÄ™ po animacji)
    if (this.introPaper.animation >= this.introPaper.maxAnimation) {
      // TÅ‚o przycisku - spÃ³jne z gÅ‚Ã³wnymi przyciskami
      ctx.fillStyle = "#2d3748";
      ctx.fillRect(-50, 100, 100, 40);

      // Obramowanie przycisku
      ctx.strokeStyle = "#4a5568";
      ctx.lineWidth = 2;
      ctx.strokeRect(-50, 100, 100, 40);

      // Tekst przycisku - biaÅ‚y dla maksymalnej czytelnoÅ›ci
      ctx.fillStyle = "#ffffff";
      ctx.font = "bold 16px serif";
      ctx.textAlign = "center";
      ctx.fillText("DO GRY", 0, 125);
    }

    ctx.restore();
  }

  // NOWA METODA - losowy czas do nastÄ™pnej bÅ‚yskawicy
  getRandomLightningTime() {
    return Math.random() * 300 + 180; // 3-8 sekund (przy 60 FPS)
  }

  // NOWA METODA - generowanie bÅ‚yskawicy
  createLightning() {
    this.lightning.active = true;
    this.lightning.intensity = 1;
    this.lightning.duration = Math.random() * 20 + 10; // 10-30 klatek
    this.lightning.branches = [];

    // GÅ‚Ã³wna gaÅ‚Ä…Åº bÅ‚yskawicy
    const startX = Math.random() * 800;
    const startY = 0;
    this.lightning.branches.push(
      this.generateLightningBranch(startX, startY, 0, Math.random() * 400 + 200)
    );

    // Dodatkowe gaÅ‚Ä™zie (30% szans)
    if (Math.random() < 0.3) {
      const branchX = Math.random() * 800;
      this.lightning.branches.push(
        this.generateLightningBranch(branchX, 0, 0, Math.random() * 300 + 150)
      );
    }
  }

  // NOWA METODA - generowanie gaÅ‚Ä™zi bÅ‚yskawicy
  generateLightningBranch(startX, startY, startAngle, maxLength) {
    const points = [{ x: startX, y: startY }];
    let currentX = startX;
    let currentY = startY;
    let currentAngle = startAngle;
    let remainingLength = maxLength;

    while (remainingLength > 0 && currentY < 600) {
      // Losowa zmiana kierunku
      currentAngle += (Math.random() - 0.5) * 0.8;

      // Losowa dÅ‚ugoÅ›Ä‡ segmentu
      const segmentLength = Math.random() * 30 + 15;
      const actualLength = Math.min(segmentLength, remainingLength);

      currentX += Math.sin(currentAngle) * actualLength;
      currentY += Math.cos(currentAngle) * actualLength + actualLength * 0.7; // bias w dÃ³Å‚

      points.push({ x: currentX, y: currentY });
      remainingLength -= actualLength;

      // Szansa na rozgaÅ‚Ä™zienie (10%)
      if (Math.random() < 0.1 && remainingLength > 50) {
        const branchAngle = currentAngle + (Math.random() - 0.5) * 1.5;
        const branchLength = remainingLength * (Math.random() * 0.6 + 0.2);
        // Rekursywnie dodaj mniejszÄ… gaÅ‚Ä…Åº
        const subBranch = this.generateLightningBranch(
          currentX,
          currentY,
          branchAngle,
          branchLength
        );
        return { main: points, branches: [subBranch] };
      }
    }

    return { main: points, branches: [] };
  }

  // NOWA METODA - aktualizacja bÅ‚yskawic
  updateLightning() {
    this.lightning.timer++;

    if (this.lightning.active) {
      this.lightning.duration--;

      // Migotanie bÅ‚yskawicy
      if (this.lightning.duration > 0) {
        this.lightning.intensity = Math.random() * 0.7 + 0.3;
      } else {
        this.lightning.active = false;
        this.lightning.intensity = 0;
        this.lightning.nextStrike =
          this.lightning.timer + this.getRandomLightningTime();
      }
    } else {
      // SprawdÅº czy czas na nowÄ… bÅ‚yskawicÄ™
      if (this.lightning.timer >= this.lightning.nextStrike) {
        this.createLightning();
        this.lightning.timer = 0;
      }
    }
  }

  // NOWA METODA - rysowanie bÅ‚yskawic
  drawLightning() {
    if (!this.lightning.active || this.lightning.intensity <= 0) return;

    ctx.save();

    // Globalne oÅ›wietlenie od bÅ‚yskawicy
    ctx.globalAlpha = this.lightning.intensity * 0.4;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, 800, 600);

    // Rysowanie gaÅ‚Ä™zi bÅ‚yskawicy
    ctx.globalAlpha = this.lightning.intensity;
    ctx.strokeStyle = "#ffffff";
    ctx.shadowColor = "#a0c4ff";
    ctx.shadowBlur = 15;
    ctx.lineWidth = 3;

    for (let branch of this.lightning.branches) {
      this.drawLightningBranch(branch);
    }

    ctx.restore();
  }

  // NOWA METODA - rysowanie pojedynczej gaÅ‚Ä™zi
  drawLightningBranch(branch) {
    // Rysuj gÅ‚Ã³wnÄ… gaÅ‚Ä…Åº
    if (branch.main && branch.main.length > 1) {
      ctx.beginPath();
      ctx.moveTo(branch.main[0].x, branch.main[0].y);

      for (let i = 1; i < branch.main.length; i++) {
        ctx.lineTo(branch.main[i].x, branch.main[i].y);
      }
      ctx.stroke();

      // WewnÄ™trzny blask
      ctx.save();
      ctx.strokeStyle = "#e0f0ff";
      ctx.lineWidth = 1;
      ctx.shadowBlur = 5;
      ctx.beginPath();
      ctx.moveTo(branch.main[0].x, branch.main[0].y);
      for (let i = 1; i < branch.main.length; i++) {
        ctx.lineTo(branch.main[i].x, branch.main[i].y);
      }
      ctx.stroke();
      ctx.restore();
    }

    // Rysuj podgaÅ‚Ä™zie
    if (branch.branches) {
      for (let subBranch of branch.branches) {
        ctx.save();
        ctx.lineWidth = 2;
        this.drawLightningBranch(subBranch);
        ctx.restore();
      }
    }
  }

  initRain() {
    this.rainDrops = [];
    // StwÃ³rz poczÄ…tkowe krople deszczu
    for (let i = 0; i < 100; i++) {
      this.rainDrops.push(this.createRainDrop());
    }
  }

  // NOWA METODA - tworzenie pojedynczej kropli
  createRainDrop() {
    return {
      x: Math.random() * 800,
      y: Math.random() * 600,
      speed: Math.random() * 3 + 2, // prÄ™dkoÅ›Ä‡ 2-5
      length: Math.random() * 15 + 5, // dÅ‚ugoÅ›Ä‡ 5-20
      opacity: Math.random() * 0.6 + 0.2, // przezroczystoÅ›Ä‡ 0.2-0.8
      angle: Math.random() * 0.2 - 0.1 // lekki kÄ…t -0.1 do 0.1
    };
  }

  // NOWA METODA - aktualizacja pozycji kropli
  updateRain() {
    for (let drop of this.rainDrops) {
      // Poruszaj kroplÄ™ w dÃ³Å‚
      drop.y += drop.speed;
      drop.x += drop.angle * drop.speed; // lekki ruch w bok

      // JeÅ›li kropla wyszÅ‚a poza ekran, zresetuj na gÃ³rze
      if (drop.y > 600) {
        drop.y = -drop.length;
        drop.x = Math.random() * 800;
        drop.speed = Math.random() * 3 + 2;
        drop.length = Math.random() * 15 + 5;
        drop.opacity = Math.random() * 0.6 + 0.2;
        drop.angle = Math.random() * 0.2 - 0.1;
      }

      // JeÅ›li kropla wyszÅ‚a z boku, przenieÅ› na drugÄ… stronÄ™
      if (drop.x < -10) drop.x = 810;
      if (drop.x > 810) drop.x = -10;
    }
  }

  // NOWA METODA - rysowanie deszczu
  drawRain() {
    ctx.save();

    // Rysuj krople deszczu
    for (let drop of this.rainDrops) {
      ctx.globalAlpha = drop.opacity;
      ctx.strokeStyle = "#a0c4e0"; // bladoniebieska barwa deszczu
      ctx.lineWidth = 1;

      // Narysuj liniÄ™ kropli
      ctx.beginPath();
      ctx.moveTo(drop.x, drop.y);
      ctx.lineTo(drop.x + drop.angle * drop.length, drop.y + drop.length);
      ctx.stroke();
    }

    // Dodaj efekt mgÅ‚y/pary
    const fogGradient = ctx.createLinearGradient(0, 500, 0, 600);
    fogGradient.addColorStop(0, "rgba(200, 220, 240, 0.1)");
    fogGradient.addColorStop(1, "rgba(200, 220, 240, 0.3)");
    ctx.fillStyle = fogGradient;
    ctx.fillRect(0, 500, 800, 100);

    ctx.restore();
  }

  // NOWA METODA - efekt kaÅ‚uÅ¼
  drawPuddles() {
    ctx.save();
    ctx.globalAlpha = 0.3;

    // KaÅ‚uÅ¼a 1
    ctx.fillStyle = "#4a6a8a";
    ctx.beginPath();
    ctx.ellipse(150, 580, 40, 8, 0, 0, 2 * Math.PI);
    ctx.fill();

    // KaÅ‚uÅ¼a 2
    ctx.beginPath();
    ctx.ellipse(450, 570, 30, 6, 0, 0, 2 * Math.PI);
    ctx.fill();

    // KaÅ‚uÅ¼a 3
    ctx.beginPath();
    ctx.ellipse(650, 585, 35, 7, 0, 0, 2 * Math.PI);
    ctx.fill();

    // Odbicia Å›wiatÅ‚a w kaÅ‚uÅ¼ach
    ctx.globalAlpha = 0.2;
    ctx.fillStyle = "#ffffff";
    ctx.beginPath();
    ctx.ellipse(150, 580, 20, 4, 0, 0, 2 * Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(450, 570, 15, 3, 0, 0, 2 * Math.PI);
    ctx.fill();

    ctx.restore();
  }

  startMusic() {
    if (!this.musicStarted) {
      this.backgroundMusic
        .play()
        .then(() => {
          console.log("Muzyka uruchomiona!");
          this.musicStarted = true;
          // USUÅƒ obszar klikniÄ™cia muzyki
          this.clickAreas = this.clickAreas.filter(
            (area) =>
              !(
                area.x === 0 &&
                area.y === 0 &&
                area.w === 800 &&
                area.h === 600
              )
          );
        })
        .catch((e) => {
          console.log("Nie moÅ¼na odtworzyÄ‡ muzyki:", e);
        });
    }
  }

  render() {
    // Rysuj zdjÄ™cie jako tÅ‚o
    const img = new Image();
    img.src = "https://i.imgur.com/4eI9vWb.png";
    if (img.complete) {
      ctx.drawImage(img, 0, 0, 800, 600);
    } else {
      // Fallback - gradient jak byÅ‚o wczeÅ›niej (ale ciemniejszy dla deszczu)
      const gradient = ctx.createLinearGradient(0, 0, 0, 600);
      gradient.addColorStop(0, "#1a1a2e");
      gradient.addColorStop(0.5, "#16213e");
      gradient.addColorStop(1, "#0f0f1e");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, 800, 600);
    }

    // AKTUALIZUJ I NARYSUJ DESZCZ
    this.updateRain();

    // AKTUALIZUJ I NARYSUJ BÅYSKAWICE
    this.updateLightning();
    this.drawLightning();

    this.drawRain();

    this.animation += 0.02;

    // Dodaj lekkie przyciemnienie przez deszcz (ale nie podczas bÅ‚yskawicy)
    if (!this.lightning.active) {
      ctx.fillStyle = "rgba(30, 40, 60, 0.3)";
      ctx.fillRect(0, 0, 800, 600);
    }

    ctx.save();
    ctx.shadowColor = "rgba(200, 200, 255, 0.8)";
    ctx.shadowBlur = 15;
    ctx.shadowOffsetY = Math.sin(this.animation) * 2;
    ctx.fillStyle = "#ffffff"; // BiaÅ‚y tytuÅ‚
    ctx.font = "bold 42px Georgia";
    ctx.textAlign = "center";
    ctx.fillText("STARZIK", 400, 160);

    ctx.font = "20px Georgia";
    ctx.fillStyle = "#cccccc"; // Jasny szary podtytuÅ‚
    ctx.fillText("TheSzpil", 400, 190);
    ctx.restore();

    // RESET kolorÃ³w przed przyciskami
    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#ffffff";

    // PokaÅ¼ przyciski tylko jeÅ›li kartka nie jest widoczna
    if (!this.introPaper.visible) {
      this.drawButton(300, 300, 200, 50, "ROZPOCZNIJ GRÄ˜", "main");
      this.drawButton(300, 370, 200, 50, "O GRZE", "secondary");
      this.drawButton(300, 440, 200, 50, "WWW FAMILOCKA", "secondary");
    }

    // NARYSUJ KAÅUÅ»E NA KOÅƒCU
    this.drawPuddles();

    // Dodaj informacjÄ™ o muzyce jeÅ›li nie jest uruchomiona
    if (!this.musicStarted && !this.introPaper.visible) {
      ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
      ctx.font = "14px Georgia";
      ctx.textAlign = "center";
      ctx.fillText("ğŸ”Š Kliknij gdziekolwiek aby wÅ‚Ä…czyÄ‡ muzykÄ™", 400, 550);
    }

    // AKTUALIZUJ I NARYSUJ KARTKÄ˜ WPROWADZAJÄ„CÄ„
    this.updateIntroPaper();
    this.drawIntroPaper();

    if (this.hoveredArea && !this.introPaper.visible) {
      ctx.strokeStyle = "#8a8aaa";
      ctx.lineWidth = 2;
      ctx.strokeRect(
        this.hoveredArea.x,
        this.hoveredArea.y,
        this.hoveredArea.w,
        this.hoveredArea.h
      );
    }
  }

  drawButton(x, y, w, h, text, type) {
    ctx.save();

    // SprawdÅº czy mysz jest nad przyciskiem
    const isHovered =
      this.hoveredArea && this.hoveredArea.x === x && this.hoveredArea.y === y;

    if (type === "main") {
      // PRZYCISK GÅÃ“WNY - prosty i czytelny
      if (isHovered) {
        // Hover: jaÅ›niejszy z ciepÅ‚ym akcentem
        ctx.fillStyle = "#4a5568";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#ed8936"; // CiepÅ‚y pomaraÅ„czowy
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);
      } else {
        // Normalny: ciemny ale nie za bardzo
        ctx.fillStyle = "#2d3748";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#4a5568";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);
      }
      // Tekst zawsze jasny i czytelny
      ctx.fillStyle = "#ffffff";
    } else if (type === "fullscreen") {
      // PRZYCISK PEÅNEGO EKRANU - mniejszy, kompaktowy
      if (isHovered) {
        ctx.fillStyle = "#4a5568";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#38a169"; // Zielony akcent
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);
      } else {
        ctx.fillStyle = "#2d3748";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#4a5568";
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, w, h);
      }
      ctx.fillStyle = "#ffffff";
    } else {
      // PRZYCISKI DRUGORZÄ˜DNE - jeszcze prostsze
      if (isHovered) {
        ctx.fillStyle = "#3a4555";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#5a6a7a";
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, w, h);
      } else {
        ctx.fillStyle = "#1a202c";
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = "#2d3748";
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, w, h);
      }
      // Tekst jaÅ›niejszy przy hover
      ctx.fillStyle = isHovered ? "#ffffff" : "#cbd5e0";
    }

    // Lekki efekt mokroÅ›ci na gÃ³rze przycisku
    if (!this.lightning.active) {
      ctx.globalAlpha = 0.1;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(x + 5, y + 5, w - 10, 6);
    }

    ctx.restore();

    // Tekst przycisku - bold dla lepszej czytelnoÅ›ci
    ctx.font =
      type === "fullscreen" ? "bold 12px Georgia" : "bold 16px Georgia";
    ctx.textAlign = "center";
    ctx.fillText(text, x + w / 2, y + h / 2 + 5);
  }
} // â† ZAMYKA KLASÄ˜ MenuScene

class CourtyardScene extends Scene {
  constructor() {
    super();
    this.setupAreas();

    // SYSTEM DESZCZU (subtelny w podwÃ³rku)
    this.rainDrops = [];
    this.initRain();

    // DÅºwiÄ™k ksiÄ™Å¼yca
    this.moonSound = new Audio("https://files.catbox.moe/q9a53b.mp3");
    this.moonSound.volume = 0.7;

    // NOWY DÅ¹WIÄ˜K PSA
    this.dogSound = new Audio("https://files.catbox.moe/7s8f1a.mp3");
    this.dogSound.volume = 0.8;

    // DODAJ MUZYKÄ˜ TÅA:
    this.backgroundMusic = new Audio("https://files.catbox.moe/ngqi9t.mp3");
    this.backgroundMusic.loop = true;
    this.backgroundMusic.volume = 0.3;
    this.musicStarted = false;
  }

  setupAreas() {
    // KRATKA KANALIZACYJNA (Å›rodek, na dole) - STREFA 0
    this.addArea(360, 470, 80, 80, () => {
      if (gameState.wellOpened) {
        showDialog("Kratka kanalizacyjna jest juÅ¼ otwarta.");
      } else {
        showCodeInput();
      }
    });

    // ÅOPATKA (maÅ‚a, przy kratce) - STREFA 1 - OK
    this.addArea(320, 490, 20, 30, () => {
      if (!gameState.hasSpade) {
        addItem("Åopatka");
        gameState.hasSpade = true;
        showDialog("ZnalazÅ‚eÅ› Å‚opatkÄ™!");
      } else {
        showDialog("JuÅ¼ nie ma tu wiÄ™cej Å‚opatek.");
      }
    });

    // KOPCZYK ZIEMI (prawy dolny rÃ³g) - STREFA 2 - OK
    this.addArea(650, 560, 20, 15, () => {
      if (gameState.hasBone) {
        if (gameState.boneVisible) {
          addItem("KoÅ›Ä‡");
          gameState.boneVisible = false;
          showDialog("PodniosÅ‚eÅ› starÄ… koÅ›Ä‡!");
        } else {
          showDialog("Tu juÅ¼ wykopaÅ‚eÅ› koÅ›Ä‡.");
        }
      } else if (hasItem("Åopatka")) {
        gameState.hasBone = true;
        gameState.boneVisible = true;
        removeItem("Åopatka"); // DODAJ
        showDialog("WykopaÅ‚eÅ› starÄ… koÅ›Ä‡! MoÅ¼esz jÄ… teraz podnieÅ›Ä‡.");
      } else {
        showDialog("Kopczyk ziemi. PotrzebujÄ™ czegoÅ› do kopania.");
      }
    });

    // KOÅšÄ† (gdy widoczna)
    if (gameState.boneVisible) {
      this.addArea(655, 565, 12, 8, () => {
        addItem("KoÅ›Ä‡");
        gameState.boneVisible = false;
        showDialog("PodniosÅ‚eÅ› starÄ… koÅ›Ä‡!");
      });
    }

    // PANI SPRZÄ„TAJÄ„CA (lewa postaÄ‡) - STREFA 3 - POPRAWKA
    this.addArea(70, 375, 75, 130, () => this.talkToJanitor());

    // DRZWI BUDYNKU - STREFA 4 - POPRAWKA (szersze, obejmuje caÅ‚e drzwi)
    this.addArea(370, 280, 80, 140, () => {
      if (gameState.intercomUnlocked) {
        changeScene("staircase");
      } else {
        showDialog("Drzwi sÄ… zamkniÄ™te. SprÃ³buj uÅ¼yÄ‡ domofonu...");
      }
    });

    // PAN KOWALSKI Z PSEM (prawa postaÄ‡) - STREFA 5 - POPRAWKA
    this.addArea(550, 330, 70, 180, () => this.talkToNeighbor());

    // DOMOFON - STREFA 6 - POPRAWKA (mniejszy, precyzyjniej)
    this.addArea(470, 320, 30, 50, () => showIntercomKeypad());

    // LISTONOSZ (Å›rodkowa postaÄ‡) - POPRAWKA (lepsze dopasowanie)
    this.addArea(230, 375, 80, 140, () => this.talkToPostman());

    // KSIÄ˜Å»YC (jasne koÅ‚o u gÃ³ry) - POPRAWKA (wedÅ‚ug screenshota)
    this.addArea(360, 45, 70, 60, () => this.clickMoon());

    // PIES BUREK (przy Panu Kowalskim)
    this.addArea(460, 480, 70, 40, () => this.clickDog());
  }

  // SYSTEM DESZCZU (podobny jak w menu, ale subtelniejszy)
  initRain() {
    this.rainDrops = [];
    for (let i = 0; i < 60; i++) {
      this.rainDrops.push(this.createRainDrop());
    }
  }

  createRainDrop() {
    return {
      x: Math.random() * 800,
      y: Math.random() * 600,
      speed: Math.random() * 2 + 1.5,
      length: Math.random() * 12 + 4,
      opacity: Math.random() * 0.4 + 0.1,
      angle: Math.random() * 0.15 - 0.075
    };
  }

  updateRain() {
    for (let drop of this.rainDrops) {
      drop.y += drop.speed;
      drop.x += drop.angle * drop.speed;

      if (drop.y > 600) {
        drop.y = -drop.length;
        drop.x = Math.random() * 800;
        drop.speed = Math.random() * 2 + 1.5;
        drop.length = Math.random() * 12 + 4;
        drop.opacity = Math.random() * 0.4 + 0.1;
        drop.angle = Math.random() * 0.15 - 0.075;
      }

      if (drop.x < -10) drop.x = 810;
      if (drop.x > 810) drop.x = -10;
    }
  }

  drawRain() {
    ctx.save();
    for (let drop of this.rainDrops) {
      ctx.globalAlpha = drop.opacity;
      ctx.strokeStyle = "#a0c4e0";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(drop.x, drop.y);
      ctx.lineTo(drop.x + drop.angle * drop.length, drop.y + drop.length);
      ctx.stroke();
    }
    ctx.restore();
  }

  // INTERAKTYWNE ELEMENTY DO NARYSOWANIA
  drawSewerGrate() {
    const grateX = 350,
      grateY = 450;

    if (!gameState.wellOpened) {
      // KRATKA Z KÅÃ“DKÄ„ - zamkniÄ™ta
      ctx.fillStyle = "#3a3a3a";
      ctx.fillRect(grateX + 10, grateY + 20, 80, 80);

      // Kratka metalowa
      ctx.fillStyle = "#0a0a0a";
      ctx.fillRect(grateX + 15, grateY + 25, 70, 70);

      // PrÄ™ty kratki
      for (let i = 0; i < 6; i++) {
        ctx.fillStyle = "#4a4a4a";
        ctx.fillRect(grateX + 20 + i * 10, grateY + 25, 3, 70);
        ctx.fillRect(grateX + 15, grateY + 30 + i * 10, 70, 3);
      }

      // KÅÃ“DKA
      ctx.fillStyle = "#4a4a2a";
      ctx.fillRect(grateX + 40, grateY + 50, 20, 15);
      ctx.strokeStyle = "#6a6a4a";
      ctx.lineWidth = 2;
      ctx.strokeRect(grateX + 40, grateY + 50, 20, 15);

      // Ucho kÅ‚Ã³dki
      ctx.strokeStyle = "#5a5a3a";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(grateX + 50, grateY + 48, 8, Math.PI, 0);
      ctx.stroke();
    } else {
      // KRATKA OTWARTA - bez kÅ‚Ã³dki
      ctx.fillStyle = "#3a3a3a";
      ctx.fillRect(grateX + 10, grateY + 20, 80, 80);

      ctx.fillStyle = "#0a0a0a";
      ctx.fillRect(grateX + 15, grateY + 25, 70, 70);

      // PrÄ™ty kratki (bez kÅ‚Ã³dki)
      for (let i = 0; i < 6; i++) {
        ctx.fillStyle = "#4a4a4a";
        ctx.fillRect(grateX + 20 + i * 10, grateY + 25, 3, 70);
        ctx.fillRect(grateX + 15, grateY + 30 + i * 10, 70, 3);
      }
    }
  }

  drawSpade() {
    if (gameState.hasSpade) return; // Nie rysuj jeÅ›li wziÄ™ta

    const spadeX = 320,
      spadeY = 480;

    // Trzonek Å‚opatki
    ctx.fillStyle = "#8a6a4a";
    ctx.fillRect(spadeX + 10, spadeY, 4, 35);

    // SÅ‚oje drewna
    ctx.fillStyle = "#7a5a3a";
    ctx.fillRect(spadeX + 10, spadeY + 5, 4, 1);
    ctx.fillRect(spadeX + 10, spadeY + 12, 4, 1);
    ctx.fillRect(spadeX + 10, spadeY + 20, 4, 1);

    // Metalowa czÄ™Å›Ä‡
    ctx.fillStyle = "#5a5a5a";
    ctx.fillRect(spadeX + 6, spadeY + 30, 12, 8);

    // Odblaski na metalu
    ctx.fillStyle = "#7a7a7a";
    ctx.fillRect(spadeX + 7, spadeY + 31, 2, 1);
    ctx.fillRect(spadeX + 15, spadeY + 33, 2, 1);
  }

  drawMound() {
    const mound2X = 650,
      mound2Y = 560;

    if (!gameState.hasBone) {
      // KOPCZYK ZIEMI - normalny
      ctx.fillStyle = "#4a3a2a";
      ctx.beginPath();
      ctx.ellipse(mound2X + 8, mound2Y + 6, 8, 5, 0, 0, 2 * Math.PI);
      ctx.fill();

      ctx.fillStyle = "#5a4a3a";
      ctx.beginPath();
      ctx.ellipse(mound2X + 8, mound2Y + 4, 5, 3, 0, 0, 2 * Math.PI);
      ctx.fill();
    } else if (!gameState.boneVisible) {
      // WYKOPANA DZIURA - po zabraniu koÅ›ci
      ctx.fillStyle = "#2a2a1a";
      ctx.beginPath();
      ctx.ellipse(mound2X + 8, mound2Y + 6, 10, 6, 0, 0, 2 * Math.PI);
      ctx.fill();

      ctx.fillStyle = "#1a1a0a";
      ctx.beginPath();
      ctx.ellipse(mound2X + 8, mound2Y + 6, 6, 4, 0, 0, 2 * Math.PI);
      ctx.fill();
    } else {
      // WYKOPANY Z WIDOCZNÄ„ KOÅšCIÄ„
      ctx.fillStyle = "#3a3a2a";
      ctx.beginPath();
      ctx.ellipse(mound2X + 8, mound2Y + 6, 9, 6, 0, 0, 2 * Math.PI);
      ctx.fill();
    }
  }
  startMusic() {
    if (!this.musicStarted) {
      this.backgroundMusic
        .play()
        .then(() => {
          console.log("Muzyka podwÃ³rka uruchomiona!");
          this.musicStarted = true;
        })
        .catch((e) => {
          console.log("Nie moÅ¼na odtworzyÄ‡ muzyki podwÃ³rka:", e);
        });
    }
  }
  drawBone() {
    if (!gameState.boneVisible) return; // Nie rysuj jeÅ›li nie widoczna

    const boneX = 655,
      boneY = 565;

    // GÅ‚Ã³wna czÄ™Å›Ä‡ koÅ›ci
    ctx.fillStyle = "#eaeaea";
    ctx.fillRect(boneX, boneY, 12, 4);

    // KoÅ„cÃ³wki koÅ›ci
    ctx.fillStyle = "#f0f0f0";
    ctx.beginPath();
    ctx.arc(boneX + 1, boneY + 2, 3, 0, 2 * Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(boneX + 11, boneY + 2, 3, 0, 2 * Math.PI);
    ctx.fill();

    // SzczegÃ³Å‚y koÅ›ci
    ctx.fillStyle = "#d0d0d0";
    ctx.fillRect(boneX + 3, boneY + 1, 1, 1);
    ctx.fillRect(boneX + 7, boneY + 3, 1, 1);
    ctx.fillRect(boneX + 9, boneY + 1, 1, 1);
  }

  // DIALOGI Z POSTACIAMI
  talkToJanitor() {
    if (gameState.askedAboutIntercomCode && hasItem("MaÅ‚y kluczyk")) {
      const options = [
        {
          text: "ZnalazÅ‚em Pani kluczyk!",
          action: () => {
            showDialog(
              "Pani sprzÄ…tajÄ…ca: 'O, wspaniale! Kod jest napisany na zawieszce. Kliknij na kluczyk w ekwipunku!'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pani sprzÄ…tajÄ…ca: 'ZnalazÅ‚ Pan mÃ³j kluczyk?'",
        options,
        "ğŸ‘µ Pani SprzÄ…tajÄ…ca"
      );
    } else if (gameState.readLetter && !gameState.askedAboutIntercomCode) {
      const options = [
        {
          text: "Mam pytanie o tymczasowy kod do domofonu...",
          action: () => {
            gameState.askedAboutIntercomCode = true;
            showDialog(
              "Pani sprzÄ…tajÄ…ca: 'Och tak! MiaÅ‚am kod na zawieszce przy kluczu, ale go zgubiÅ‚am. MoÅ¼e gdzieÅ› w okolicy?'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pani sprzÄ…tajÄ…ca: 'DzieÅ„ dobry! SÅ‚yszaÅ‚am, Å¼e sÄ… problemy z domofonem?'",
        options,
        "Pani SprzÄ…tajÄ…ca"
      );
    } else if (gameState.gotInfoFromKowalski) {
      const options = [
        {
          text: "Pan Kowalski mÃ³wiÅ‚, Å¼e coÅ› Pani mÃ³wiÅ‚a o oknach...",
          action: () => {
            if (!gameState.askedAboutWindows) {
              gameState.askedAboutWindows = true;
              showDialog(
                "Pani sprzÄ…tajÄ…ca: 'Ach tak! SprzÄ…tam okna w tym budynku. 6 okien juÅ¼ lÅ›ni jak zÅ‚oto, ale resztÄ™ trzeba jeszcze umyÄ‡. MoÅ¼e to ma jakieÅ› powiÄ…zanie z kratkÄ… kanalizacyjnÄ…? Nie wiem...'"
              );
            } else {
              showDialog(
                "Pani sprzÄ…tajÄ…ca: 'Hm... umyte 6 okien, a dokÅ‚adnie 3, 1 i 2'"
              );
            }
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pani sprzÄ…tajÄ…ca: 'DzieÅ„ dobry! Pan Kowalski coÅ› mÃ³wiÅ‚?'",
        options,
        "ğŸ‘µ Pani SprzÄ…tajÄ…ca"
      );
    } else {
      const options = [
        {
          text: "Co Pani tutaj robi?",
          action: () => {
            showDialog(
              "Pani sprzÄ…tajÄ…ca: 'SprzÄ…tam podwÃ³rko i okna. KtoÅ› musi dbaÄ‡ o porzÄ…dek!'"
            );
          }
        },
        {
          text: "Jak dÅ‚ugo Pani tu pracuje?",
          action: () => {
            showDialog(
              "Pani sprzÄ…tajÄ…ca: 'JuÅ¼ wiele lat. Znam kaÅ¼dy kÄ…t tego budynku!'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pani sprzÄ…tajÄ…ca: 'DzieÅ„ dobry! PiÄ™kny wieczÃ³r na sprzÄ…tanie.'",
        options,
        "ğŸ‘µ Pani SprzÄ…tajÄ…ca"
      );
    }
  }

  talkToNeighbor() {
    if (gameState.gotInfoFromKowalski) {
      const options = [
        {
          text: "JuÅ¼ rozmawiaÅ‚em z paniÄ… sprzÄ…tajÄ…cÄ….",
          action: () => {
            showDialog(
              "Pan Kowalski: 'Dobrze! Ona wie wszystko o tym budynku!'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pan Kowalski: 'Burek jest zadowolony! Jak poszÅ‚o z paniÄ… sprzÄ…tajÄ…cÄ…?'",
        options,
        "ğŸ‘¨ Pan Kowalski"
      );
    } else if (gameState.gaveBone) {
      const options = [
        {
          text: "PotrzebujÄ™ pomocy...",
          action: () => {
            gameState.gotInfoFromKowalski = true;
            showDialog(
              "Pan Kowalski: 'Pani sprzÄ…tajÄ…ca czÄ™sto coÅ› mÃ³wiÅ‚a o oknach w tym budynku. MoÅ¼e ona wie wiÄ™cej?'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pan Kowalski: 'Burek jest szczÄ™Å›liwy! Czym mogÄ™ siÄ™ odwdziÄ™czyÄ‡?'",
        options,
        "ğŸ‘¨ Pan Kowalski"
      );
    } else if (hasItem("KoÅ›Ä‡")) {
      const options = [
        {
          text: "Mam coÅ› dla Burka...",
          action: () => {
            removeItem("KoÅ›Ä‡");
            gameState.gaveBone = true;
            showDialog(
              "Pan Kowalski: 'Burek uwielbia koÅ›ci! DziÄ™kujÄ™ bardzo!'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pan Kowalski: 'DzieÅ„ dobry! Burek jest dziÅ› bardzo niespokojny.'",
        options,
        "ğŸ‘¨ Pan Kowalski"
      );
    } else {
      const options = [
        {
          text: "Åadny pies!",
          action: () => {
            showDialog(
              "Pan Kowalski: 'To mÃ³j Burek. Ale jest gÅ‚odny - szuka czegoÅ› do gryzienia.'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Pan Kowalski: 'DzieÅ„ dobry! Burek szuka czegoÅ› do gryzienia.'",
        options,
        "ğŸ‘¨ Pan Kowalski"
      );
    }
  }

  talkToPostman() {
    if (gameState.gotLetter) {
      const options = [
        {
          text: "Czy ma Pan jeszcze listy dla mnie?",
          action: () => {
            showDialog("Listonosz: 'Nie, to byÅ‚ ostatni list na dziÅ›.'");
          }
        },
        {
          text: "DziÄ™kujÄ™ za list!",
          action: () => {
            showDialog("Listonosz: 'ProszÄ™ bardzo! To moja praca.'");
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Listonosz: 'List juÅ¼ Pan odebraÅ‚.'",
        options,
        "ğŸ“® Listonosz"
      );
    } else if (hasItem("DowÃ³d osobisty")) {
      const options = [
        {
          text: "Mam dowÃ³d osobisty.",
          action: () => {
            gameState.gotLetter = true;
            addItem("List");
            removeItem("DowÃ³d osobisty"); // DODAJ
            showDialog("Listonosz: 'Åšwietnie! Oto Pana list.'");
          }
        },
        {
          text: "Co to za list?",
          action: () => {
            showDialog(
              "Listonosz: 'Od UrzÄ™du Miasta. Ale muszÄ™ sprawdziÄ‡ toÅ¼samoÅ›Ä‡.'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Listonosz: 'Czy ma Pan dowÃ³d osobisty?'",
        options,
        "ğŸ“® Listonosz"
      );
    } else {
      const options = [
        {
          text: "Czy ma Pan list dla mnie?",
          action: () => {
            showDialog(
              "Listonosz: 'Tak, ale potrzebujÄ™ zobaczyÄ‡ dowÃ³d osobisty. Taki przepis!'"
            );
          }
        },
        {
          text: "Dlaczego Pan tutaj stoi?",
          action: () => {
            showDialog(
              "Listonosz: 'Czekam na Pana! Mam waÅ¼ny list od UrzÄ™du Miasta.'"
            );
          }
        },
        {
          text: "â† ZakoÅ„cz rozmowÄ™",
          action: () => {
            hideDialog();
          }
        }
      ];
      showDialogWithOptions(
        "Listonosz: 'DzieÅ„ dobry! PotrzebujÄ™ zobaczyÄ‡ dowÃ³d osobisty.'",
        options,
        "ğŸ“® Listonosz"
      );
    }
  }

  // METODA KLIKNIÄ˜CIA KSIÄ˜Å»YCA
  clickMoon() {
    this.moonSound
      .play()
      .catch((e) => console.log("Nie moÅ¼na odtworzyÄ‡ dÅºwiÄ™ku ksiÄ™Å¼yca:", e));
    showDialog("KsiÄ™Å¼yc Å›wieci tajemniczo nad ÅšwiÄ™tochÅ‚owicami...");
  }
  clickDog() {
    console.log("ğŸ• KlikniÄ™to w psa Burka");

    if (this.dogSound) {
      this.dogSound.currentTime = 0;
      this.dogSound
        .play()
        .then(() => console.log("âœ… Burek szczeka!"))
        .catch((e) => console.log("âŒ Dog sound failed:", e));
    }

    showDialog("Burek szczeka.");
  }

  render() {
    // Wybierz juÅ¼ zaÅ‚adowany obraz
    const img = gameState.intercomUnlocked
      ? preloadImages.courtyardOpen
      : preloadImages.courtyard;

    if (img.complete) {
      ctx.drawImage(img, 0, 0, 800, 600);
    } else {
      // Fallback
      ctx.fillStyle = "#2a2520";
      ctx.fillRect(0, 0, 800, 600);
    }

    // AKTUALIZUJ I NARYSUJ DESZCZ
    this.updateRain();
    this.drawRain();

    // NARYSUJ INTERAKTYWNE ELEMENTY
    this.drawSewerGrate(); // Kratka z/bez kÅ‚Ã³dki
    this.drawSpade(); // Åopatka (jeÅ›li nie wziÄ™ta)
    this.drawMound(); // Kopczyk ziemi w rÃ³Å¼nych stanach
    this.drawBone(); // KoÅ›Ä‡ (jeÅ›li widoczna)

    // Lekkie przyciemnienie dla klimatu
    ctx.fillStyle = "rgba(20, 20, 30, 0.1)";
    ctx.fillRect(0, 0, 800, 600);
    // DEBUG: Czerwone ramki stref klikalnych
    if (false) {
      // ZmieÅ„ na false aby wyÅ‚Ä…czyÄ‡
      ctx.save();
      ctx.strokeStyle = "#ff0000";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.6;

      for (let area of this.clickAreas) {
        ctx.strokeRect(area.x, area.y, area.w, area.h);

        // Etykiety obszarÃ³w
        ctx.fillStyle = "#ffff00";
        ctx.font = "11px Arial";
        ctx.textAlign = "left";
        const index = this.clickAreas.indexOf(area);
        ctx.fillText(`${index}`, area.x + 2, area.y + 13);
      }
      ctx.restore();
    }
  }
}
class StaircaseScene extends Scene {
  constructor() {
    super();
    this.setupAreas();

    // SYSTEM DESZCZU (subtelny w klatce)
    this.rainDrops = [];
    this.initRain();
    this.fuseBoxOpen = false;
    this.fuseInstalled = false;
    this.fuseBoxSolution = [6, 4, 1, 5, 3, 2];
    this.currentSequence = [];
    this.allFusesInstalled = false;

    // DODAJ MUZYKÄ˜ TÅA:
    this.backgroundMusic = new Audio("https://files.catbox.moe/ngqi9t.mp3");
    this.backgroundMusic.loop = true;
    this.backgroundMusic.volume = 0.3;
    this.musicStarted = false;

    // DODAJ DÅ¹WIÄ˜K OTWIERANIA SKRZYNKI:
    this.fuseBoxSound = new Audio("https://files.catbox.moe/jeposu.mp3");
    this.fuseBoxSound.volume = 0.7;
  }
  setupAreas() {
    // DRZWI Z NUMEREM 3 (prawe drzwi - lepsze dopasowanie)
    this.addArea(650, 200, 100, 250, () => {
      if (gameState.fuseBoxSolved) {
        showDialog(
          "Hm... zawsze byÅ‚em sprytny. Otwarcie drzwi do mieszkania bezpiecznikami, a nie kluczem..."
        );
        setTimeout(() => changeScene("apartment"));
      } else {
        showDialog("Drzwi sÄ… zamkniÄ™te. MoÅ¼e problem z prÄ…dem?");
      }
    });

    // WYCIERACZKA (czerwona mata przed drzwiami)
    this.addArea(620, 480, 100, 25, () => this.examineWycieraczka());

    // SKRZYNKA Z BEZPIECZNIKAMI (szara skrzynka na lewej Å›cianie)
    this.addArea(575, 140, 40, 70, () => this.examineFuseBox());

    // WÃ“ZEK DZIECIÄ˜CY (niebieski wÃ³zek w lewym dolnym rogu)
    this.addArea(20, 350, 150, 180, () => this.examineStroller());

    // SCHODY (czerwone schody w Å›rodku)
    this.addArea(400, 150, 80, 200, () => this.examineStairs());

    // POWRÃ“T NA PODWÃ“RKO (lewy dolny rÃ³g - area wyjÅ›cia)
    this.addArea(750, 550, 80, 60, () => {
      showDialog("Wracasz na podwÃ³rko...", 1500);
      setTimeout(() => changeScene("courtyard"), 1500);
    });
  }

  // SYSTEM DESZCZU (bardzo subtelny w klatce)
  initRain() {
    this.rainDrops = [];
    for (let i = 0; i < 10; i++) {
      this.rainDrops.push(this.createRainDrop());
    }
  }
  startMusic() {
    if (!this.musicStarted) {
      this.backgroundMusic
        .play()
        .then(() => {
          console.log("Muzyka klatki uruchomiona!");
          this.musicStarted = true;
        })
        .catch((e) => {
          console.log("Nie moÅ¼na odtworzyÄ‡ muzyki klatki:", e);
        });
    }
  }
  createRainDrop() {
    return {
      x: Math.random() * 50 + 10, // Tylko przy wejÅ›ciu
      y: Math.random() * 400 + 50,
      speed: Math.random() * 0.5 + 0.3,
      length: Math.random() * 6 + 2,
      opacity: Math.random() * 0.1 + 0.02,
      angle: Math.random() * 0.05
    };
  }

  updateRain() {
    for (let drop of this.rainDrops) {
      drop.y += drop.speed;
      drop.x += drop.angle * drop.speed;

      if (drop.y > 550) {
        drop.y = 50;
        drop.x = Math.random() * 50 + 10;
        drop.speed = Math.random() * 0.5 + 0.3;
        drop.length = Math.random() * 6 + 2;
        drop.opacity = Math.random() * 0.1 + 0.02;
        drop.angle = Math.random() * 0.05;
      }
    }
  }

  drawRain() {
    ctx.save();
    for (let drop of this.rainDrops) {
      ctx.globalAlpha = drop.opacity;
      ctx.strokeStyle = "#a0c4e0";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(drop.x, drop.y);
      ctx.lineTo(drop.x + drop.angle * drop.length, drop.y + drop.length);
      ctx.stroke();
    }
    ctx.restore();
  }

  // INTERAKCJE Z OBIEKTAMI
  examineWycieraczka() {
    const options = [
      {
        text: "PodnieÅ› wycieraczkÄ™",
        action: () => {
          if (!gameState.searchedWycieraczka) {
            gameState.searchedWycieraczka = true;
            showDialog(
              "Pod wycieraczkÄ… znalazÅ‚eÅ› stare klucze do piwnicy, ale sÄ… zbyt zardzewiaÅ‚e.",
              3000
            );
          } else {
            showDialog("JuÅ¼ sprawdziÅ‚eÅ› pod wycieraczkÄ….", 2000);
          }
        }
      },
      {
        text: "â† ZakoÅ„cz",
        action: () => {
          hideDialog();
        }
      }
    ];
    showDialogWithOptions(
      "Stara, zniszczona wycieraczka z napisem 'WITAMY'.",
      options
    );
  }

  examineFuseBox() {
    if (!this.fuseInstalled) {
      this.fuseBoxSound
        .play()
        .then(() => console.log("âœ… DÅºwiÄ™k skrzynki odtworzony"))
        .catch((e) =>
          console.log("âŒ Nie moÅ¼na odtworzyÄ‡ dÅºwiÄ™ku skrzynki:", e)
        );
      const fuseBoxContent = `
     <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
       <!-- KRZYÅ»YK W PRAWYM GÃ“RNYM ROGU -->
       <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
       
       <div style="position: relative; display: inline-block;">
         <img src="https://i.imgur.com/a4v9IHD.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="Skrzynka bezpiecznikÃ³w">
         <div onclick="window.clickEmptyFuseSlot()" style="position: absolute; top: 42%; left: 35%; width: 15%; height: 15%; cursor: pointer;"></div>
       </div>
     </div>`;

      const self = this;
      window.clickEmptyFuseSlot = () => {
        if (hasItem("Bezpiecznik")) {
          self.installFuse();
        } else {
          hideDialog();
          showDialog(
            "To puste miejsce po bezpieczniku. PotrzebujÄ™ znaleÅºÄ‡ odpowiedni bezpiecznik.",
            2000
          );
        }
      };

      showDialog(fuseBoxContent, 0);
    } else {
      this.showFuseBoxPuzzle();
    }
  }

  examineStroller() {
    const strollerContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <!-- KRZYÅ»YK W PRAWYM GÃ“RNYM ROGU -->
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <img src="https://i.imgur.com/dZhkYfM.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="WÃ³zek dzieciÄ™cy">
      <div style="text-align: center; margin-top: 15px;">
        ${
          !gameState.searchedStroller
            ? '<button onclick="window.strollerSearch()" style="padding: 10px 20px; background: #4a5568; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">PRZESZUKAJ WÃ“ZEK</button>'
            : '<button onclick="hideDialog(); showDialog(\'WÃ³zek jest juÅ¼ pusty.\', 2000)" style="padding: 10px 20px; background: #6c757d; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">JUÅ» PRZESZUKANY</button>'
        }
      </div>
    </div>`;

    const self = this;

    if (!gameState.searchedStroller) {
      window.strollerSearch = () => {
        gameState.searchedStroller = true;
        addItem("Stare monety");
        addItem("Bezpiecznik");
        hideDialog();
        showDialog(
          "W wÃ³zku znalazÅ‚eÅ› stare monety i bezpiecznik topikowy!",
          3000
        );
      };
    }

    showDialog(strollerContent, 0);
  }

  examineStairs() {
    showDialog(
      "Drewniane schody prowadzÄ… na gÃ³rne piÄ™tra. SÅ‚ychaÄ‡ skrzypienie starych desek.",
      3000
    );
  }

  render() {
    // Rysuj obraz klatki schodowej
    const img = preloadImages.staircase;
    if (img.complete) {
      ctx.drawImage(img, 0, 0, 800, 600);
    } else {
      // Fallback
      ctx.fillStyle = "#4a5c3a";
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = "#ffffff";
      ctx.font = "20px Georgia";
      ctx.textAlign = "center";
      ctx.fillText("Klatka schodowa", 400, 300);
    }

    // AKTUALIZUJ I NARYSUJ DESZCZ
    this.updateRain();
    this.drawRain();

    // Lekkie przyciemnienie dla klimatu
    ctx.fillStyle = "rgba(20, 20, 30, 0.05)";
    ctx.fillRect(0, 0, 800, 600);

    // OPCJONALNE: DEBUG - czerwone ramki obszarÃ³w klikalnych
    if (false) {
      // ZmieÅ„ na true aby zobaczyÄ‡ obszary
      ctx.save();
      ctx.strokeStyle = "#ff0000";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.6;

      for (let area of this.clickAreas) {
        ctx.strokeRect(area.x, area.y, area.w, area.h);
      }
      ctx.restore();
    }
  }
  installFuse() {
    removeItem("Bezpiecznik");
    this.fuseInstalled = true;
    hideDialog();

    const installedFuseContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <!-- KRZYÅ»YK W PRAWYM GÃ“RNYM ROGU -->
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <img src="https://i.imgur.com/pDrVYu2.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="Skrzynka z bezpiecznikami">
      <div style="text-align: center; margin: 15px 0; color: #fff; font-size: 16px;">
        Wszystkie bezpieczniki sÄ… na miejscu, teraz trzeba je wkrÄ™ciÄ‡ w dobrej kolejnoÅ›ci.
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="hideDialog(); window.startFusePuzzle()" style="padding: 10px 20px; background: #4a5568; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">ROZPOCZNIJ UKÅADANIE</button>
      </div>
    </div>`;

    const self = this;
    window.startFusePuzzle = () => {
      hideDialog();
      self.allFusesInstalled = true;
      self.showFuseBoxPuzzle();
    };

    showDialog(installedFuseContent, 0);
  }

  showFuseBoxPuzzle() {
    const puzzleContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; text-align: center;">
      <div style="color: #fff; font-size: 18px; margin-bottom: 15px;">ZAGADKA BEZPIECZNIKÃ“W</div>
      <div style="color: #ccc; font-size: 14px; margin-bottom: 20px;">Kliknij bezpieczniki w kolejnoÅ›ci: 6-4-1-5-3-2</div>
      <div style="display: grid; grid-template-columns: repeat(3, 80px); gap: 10px; justify-content: center; margin: 20px 0;">
        <button onclick="window.clickFuse(1)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">1</button>
        <button onclick="window.clickFuse(2)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">2</button>
        <button onclick="window.clickFuse(3)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">3</button>
        <button onclick="window.clickFuse(4)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">4</button>
        <button onclick="window.clickFuse(5)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">5</button>
        <button onclick="window.clickFuse(6)" style="padding: 15px; background: #4a5568; color: #fff; border: 2px solid #666; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">6</button>
      </div>
      <div style="color: #ffff99; font-size: 14px; margin: 10px 0;">Sekwencja: ${this.currentSequence.join(
        " - "
      )}</div>
      <div style="margin-top: 20px;">
        <button onclick="window.resetFuseSequence()" style="padding: 8px 16px; background: #dc3545; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">RESETUJ</button>
        <button onclick="hideDialog()" style="padding: 8px 16px; background: #6c757d; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">ZAMKNIJ</button>
      </div>
    </div>`;
    const self = this;
    window.clickFuse = (number) => {
      this.addFuseToSequence(number);
    };
    window.resetFuseSequence = () => {
      this.currentSequence = [];
      this.showFuseBoxPuzzle();
    };

    showDialog(puzzleContent, 0);
  }

  addFuseToSequence(fuseNumber) {
    this.currentSequence.push(fuseNumber);

    if (this.currentSequence.length === this.fuseBoxSolution.length) {
      if (this.arraysEqual(this.currentSequence, this.fuseBoxSolution)) {
        gameState.fuseBoxSolved = true;
        hideDialog();
        showDialog(
          "Doskonale! PrÄ…d zostaÅ‚ przywrÃ³cony. Teraz moÅ¼esz otworzyÄ‡ drzwi!",
          4000
        );
      } else {
        this.currentSequence = [];
        hideDialog();
        showDialog("NieprawidÅ‚owa kolejnoÅ›Ä‡! SprÃ³buj ponownie.", 2000);
        setTimeout(() => this.showFuseBoxPuzzle(), 2500);
      }
    } else {
      this.showFuseBoxPuzzle();
    }
  }

  arraysEqual(a, b) {
    return a.length === b.length && a.every((val, index) => val === b[index]);
  }
}
class ApartmentScene extends Scene {
  constructor() {
    super();
    this.setupAreas();

    // SYSTEM DESZCZU (subtelny w mieszkaniu)
    this.rainDrops = [];
    this.initRain();

    // Stan przeszukanych miejsc
    this.searchedPlaces = {
      bookshelf: false,
      tv: false,
      flower: false,
      picture: false,
      plant: false,
      sofa: false,
      cabinet: false,
      lamp: false,
      window: false
    };
    // DODAJ MUZYKÄ˜ TÅA:
    this.backgroundMusic = new Audio("https://files.catbox.moe/fkocm5.mp3");
    this.backgroundMusic.loop = true;
    this.backgroundMusic.volume = 0.3;
    this.musicStarted = false;
  }

  setupAreas() {
    // POPRAWIONE PRECYZYJNE OBSZARY KLIKALNE (dopasowane do rzeczywistego zdjÄ™cia)

    // REGAÅ Z KSIÄ„Å»KAMI (lewy gÃ³rny, ksiÄ…Å¼ki widoczne)
    this.addArea(110, 120, 110, 150, () => this.examineBookshelf());

    // REGAÅ Z SZKÅEM (lewy gÃ³rny, szkÅ‚o za szybÄ…)
    this.addArea(10, 80, 100, 160, () => this.examineGlassCabinet());

    // DOLNE SZAFKI PO LEWEJ (ciemne szafki na dole)
    this.addArea(20, 350, 170, 90, () => this.examineLowerCabinet());

    // TELEWIZOR (czarny ekran w Å›rodku) - PRZESUNIÄ˜TY W PRAWO
    this.addArea(260, 220, 100, 80, () => this.examineTV());

    // SZAFKA POD TV (brÄ…zowa szafka pod telewizorem) - PRZESUNIÄ˜TA W PRAWO
    this.addArea(280, 350, 100, 70, () => this.examineTVCabinet());

    // STOLICZEK Z KWIATAMI (maÅ‚y stoliczek z wazonikiem) - PRZESUNIÄ˜TY W PRAWO
    this.addArea(380, 220, 60, 100, () => this.examineFlowers());

    // OBRAZ NA ÅšCIANIE (haftowany obrazek w ramce) - PRZESUNIÄ˜TY W PRAWO
    this.addArea(460, 120, 90, 100, () => this.examinePicture());

    // ROÅšLINA W DONICZCE (zielona roÅ›lina po prawej)
    this.addArea(560, 180, 70, 130, () => this.examinePlant());

    // SOFA/KANAPA (brÄ…zowa kanapa po prawej)
    this.addArea(590, 330, 180, 150, () => this.examineSofa());

    // LAMPA WISZÄ„CA (Å¼Ã³Å‚ta lampa u gÃ³ry)
    this.addArea(340, 20, 80, 80, () => this.examineLamp());

    // OKNO Z FIRANKAMI (prawa krawÄ™dÅº z firankami)
    this.addArea(700, 50, 80, 250, () => this.examineWindow());

    // WYJÅšCIE (prawy dolny rÃ³g)
    this.addArea(730, 450, 70, 150, () => {
      showDialog("Wracasz na klatkÄ™ schodowÄ…...", 2000);
      setTimeout(() => changeScene("staircase"), 2000);

      this.addArea(400, 60, 50, 50, () => this.clickMoon());
    });
  }

  // SYSTEM DESZCZU (podobny jak w podwÃ³rku, ale subtelniejszy)
  initRain() {
    this.rainDrops = [];
    for (let i = 0; i < 20; i++) {
      // Bardzo maÅ‚o kropli przez okno
      this.rainDrops.push(this.createRainDrop());
    }
  }

  createRainDrop() {
    return {
      x: Math.random() * 100 + 720, // Tylko przy oknie
      y: Math.random() * 400 + 50,
      speed: Math.random() * 1 + 0.5,
      length: Math.random() * 8 + 3,
      opacity: Math.random() * 0.2 + 0.05,
      angle: Math.random() * 0.1 - 0.05
    };
  }
  startMusic() {
    if (!this.musicStarted) {
      this.backgroundMusic
        .play()
        .then(() => {
          console.log("Muzyka mieszkania uruchomiona!");
          this.musicStarted = true;
        })
        .catch((e) => {
          console.log("Nie moÅ¼na odtworzyÄ‡ muzyki mieszkania:", e);
        });
    }
  }
  updateRain() {
    for (let drop of this.rainDrops) {
      drop.y += drop.speed;
      drop.x += drop.angle * drop.speed;

      if (drop.y > 450) {
        drop.y = 50;
        drop.x = Math.random() * 100 + 720;
        drop.speed = Math.random() * 1 + 0.5;
        drop.length = Math.random() * 8 + 3;
        drop.opacity = Math.random() * 0.2 + 0.05;
        drop.angle = Math.random() * 0.1 - 0.05;
      }
    }
  }

  drawRain() {
    ctx.save();
    for (let drop of this.rainDrops) {
      ctx.globalAlpha = drop.opacity;
      ctx.strokeStyle = "#a0c4e0";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(drop.x, drop.y);
      ctx.lineTo(drop.x + drop.angle * drop.length, drop.y + drop.length);
      ctx.stroke();
    }
    ctx.restore();
  }

  // INTERAKCJE Z PRZEDMIOTAMI - POPRAWIONE JEDNORAZOWE BLOKADY
  examineBookshelf() {
    const options = [
      {
        text: "Przeszukaj ksiÄ…Å¼ki dokÅ‚adniej",
        action: () => {
          if (!this.searchedPlaces.bookshelf) {
            this.searchedPlaces.bookshelf = true;
            addItem("MaÅ‚y klucz do szafki");
            showDialog(
              "Za starymi ksiÄ…Å¼kami znalazÅ‚eÅ› maÅ‚y klucz do szafki! ZostaÅ‚ dodany do ekwipunku."
            );
          } else {
            showDialog("JuÅ¼ przeszukaÅ‚eÅ› ksiÄ…Å¼ki. Nic wiÄ™cej tu nie ma.");
          }
        }
      },
      {
        text: "SprawdÅº szklane naczynia",
        action: () => {
          showDialog(
            "Stare szklanki i filiÅ¼anki za szkÅ‚em. Jedna ma napis 'PamiÄ…tka z Krynicy 1975'."
          );
        }
      }
    ];
    showDialogWithOptions(
      "Stary regaÅ‚ peÅ‚en ksiÄ…Å¼ek i szkÅ‚a. KsiÄ…Å¼ki pokryte kurzem, niektÃ³re wyglÄ…dajÄ… na bardzo stare.",
      options
    );
  }

  examineGlassCabinet() {
    showDialog(
      "Stare szklanki i filiÅ¼anki za szkÅ‚em. Jedna ma napis 'PamiÄ…tka z Krynicy 1975'.",
      3000
    );
  }

  examineLowerCabinet() {
    console.log("Cabinet opened:", gameState.cabinetOpened); // DEBUG
    if (gameState.cabinetOpened) {
      this.showSafePopup();
    } else {
      const options = [
        {
          text: "WprowadÅº kod do szafki",
          action: () => {
            this.showCabinetCodeInput();
          }
        },
        {
          text: "SprawdÅº gÃ³rÄ™ szafek",
          action: () => {
            showDialog("Na szafce stoi maÅ‚a doniczka z uschniÄ™tÄ… roÅ›linÄ….");
          }
        }
      ];
      showDialogWithOptions(
        "Ciemne drewniane szafki z kÅ‚Ã³dkÄ… cyfrowÄ…. WymagajÄ… 4-cyfrowego kodu.",
        options
      );
    }
  }

  showCabinetCodeInput() {
    const codeInputContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <div style="text-align: center; color: #fff;">
        <h3>WprowadÅº 4-cyfrowy kod:</h3>
        <input type="text" id="cabinetCodeInput" placeholder="____" maxlength="4" style="padding: 10px; font-size: 20px; text-align: center; border: 2px solid #666; border-radius: 5px; background: #333; color: #fff; margin: 10px; width: 100px;">
        <br>
        <button onclick="window.checkCabinetCode()" style="padding: 10px 20px; background: #4a5568; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">SPRAWDÅ¹</button>
      </div>
    </div>
  `;

    const self = this;
    window.checkCabinetCode = () => {
      const code = document.getElementById("cabinetCodeInput").value;
      if (code === "2310") {
        gameState.cabinetOpened = true; // Zapisz stan
        hideDialog();
        showDialog(
          "Szafka siÄ™ otworzyÅ‚a! W Å›rodku znajduje siÄ™ sejf. Kliknij ponownie na szafkÄ™ aby go zobaczyÄ‡.",
          4000
        );
        // BRAK setTimeout - nie pokazuj sejfu od razu!
      } else {
        showDialog("NieprawidÅ‚owy kod!", 2000);
      }
    };

    showDialog(codeInputContent, 0);
  }

  examineTV() {
    const options = [];

    // JeÅ›li TV nie jest wÅ‚Ä…czony, dodaj opcjÄ™ wÅ‚Ä…czenia
    if (!gameState.tvTurnedOn) {
      options.push({
        text: "SprÃ³buj wÅ‚Ä…czyÄ‡ telewizor",
        action: () => {
          gameState.tvTurnedOn = true;
          this.showTVScreen();
          showDialog(
            "Telewizor siÄ™ wÅ‚Ä…czyÅ‚! Ekran Å›wieci jasnym Å›wiatÅ‚em.",
            2000
          );
        }
      });
    }

    // Zawsze dostÄ™pna opcja sprawdzenia za TV
    options.push({
      text: "SprawdÅº za telewizorem",
      action: () => {
        if (gameState.tvTurnedOn) {
          // JeÅ›li TV wÅ‚Ä…czony - pokaÅ¼ popup z kodem
          this.showTVCodePopup();
        } else {
          // JeÅ›li TV wyÅ‚Ä…czony - zwykÅ‚y komunikat
          showDialog("Za telewizorem znalazÅ‚eÅ› stare kable i pyÅ‚. Nic wiÄ™cej.");
        }
      }
    });

    showDialogWithOptions(
      "Stary telewizor kineskopowy. " +
        (gameState.tvTurnedOn
          ? "Ekran Å›wieci jasnym Å›wiatÅ‚em."
          : "WyglÄ…da jakby nie byÅ‚ uÅ¼ywany od lat."),
      options
    );
  }

  showTVScreen() {
    // ZmieÅ„ tÅ‚o sceny na obraz TV (dodaj flagÄ™ do renderowania)
    gameState.tvScreenOn = true;

    // PokaÅ¼ popup z kodem seryjnym
    this.showTVCodePopup();
  }

  showTVCodePopup() {
    const codePopup = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 2px solid #555;">
        <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
        
        <div style="text-align: center; color: #fff; font-size: 18px; padding: 15px;">
          <strong>Nr seryjny: I-2 II-1 III-8 IV-6 V-5</strong>
        </div>
      </div>
    `;
    showDialog(codePopup, 0);
  }

  examineTVCabinet() {
    const options = [
      {
        text: "OtwÃ³rz szafkÄ™",
        action: () => {
          if (!this.searchedPlaces.tv && hasItem("MaÅ‚y klucz do szafki")) {
            this.searchedPlaces.tv = true;
            addItem("PamiÄ™tnik");
            addItem("Notes z telefonami");
            removeItem("MaÅ‚y klucz do szafki");
            showDialog(
              "Klucz pasuje! W szafce znalazÅ‚eÅ› pamiÄ™tnik dziadka i notes z numerami telefonÃ³w. Dodano do ekwipunku."
            );
          } else if (!hasItem("MaÅ‚y klucz do szafki")) {
            showDialog(
              "Szafka jest zamkniÄ™ta na klucz. Potrzebujesz odpowiedni klucz aby jÄ… otworzyÄ‡."
            );
          } else {
            showDialog("Szafka jest juÅ¼ otwarta i pusta.");
          }
        }
      },
      {
        text: "SprawdÅº z zewnÄ…trz",
        action: () => {
          showDialog("Szafka wyglÄ…da na zamkniÄ™tÄ…. MoÅ¼e potrzebujÄ™ klucza?");
        }
      }
    ];
    showDialogWithOptions(
      "Szafka pod telewizorem. Drzwiczki sÄ… zamkniÄ™te.",
      options
    );
  }

  examineFlowers() {
    const options = [
      {
        text: "SprawdÅº wazon bliÅ¼ej",
        action: () => {
          showDialog(
            "Na wazonie widaÄ‡ napis 'JÃ³zef & Maria 1967' - pamiÄ…tka Å›lubna dziadkÃ³w."
          );
        }
      },
      {
        text: "Podziwiaj kwiaty",
        action: () => {
          showDialog(
            "PiÄ™kne sztuczne kwiaty w stonowanych kolorach. WyglÄ…dajÄ… jakby byÅ‚y tu od dziesiÄ™cioleci."
          );
        }
      }
    ];
    showDialogWithOptions(
      "Wazon z sztucznymi kwiatami na maÅ‚ym stoliczku.",
      options
    );
  }

  examinePicture() {
    const options = [
      {
        text: "SprawdÅº za obrazem",
        action: () => {
          if (hasItem("PamiÄ™tnik")) {
            this.showHiddenPicture();
          } else {
            showDialog(
              "Za obrazem jest pusta Å›ciana. MoÅ¼e potrzebujÄ™ wskazÃ³wki gdzie szukaÄ‡?"
            );
          }
        }
      },
      {
        text: "Przyjrzyj siÄ™ obrazowi",
        action: () => {
          showDialog(
            "Haftowany obraz przedstawia wieniec z kwiatÃ³w. Praca rÄ™czna, prawdopodobnie z lat 60-tych."
          );
        }
      }
    ];
    showDialogWithOptions(
      "PiÄ™kny haftowany obraz w drewnianej ramie. WyglÄ…da na pamiÄ…tkÄ™ rodzinnÄ….",
      options
    );
  }

  examinePlant() {
    const options = [
      {
        text: "SprawdÅº doniczkÄ™",
        action: () => {
          showDialog(
            "BrÄ…zowa ceramiczna doniczka. Na spodzie widaÄ‡ napis 'Ceramika BolesÅ‚awiec 1978'."
          );
        }
      },
      {
        text: "SprawdÅº liÅ›cie",
        action: () => {
          showDialog(
            "RoÅ›lina wyglÄ…da zdrowo mimo wieku mieszkania. KtoÅ› musiaÅ‚ o niÄ… dbaÄ‡ do niedawna."
          );
        }
      }
    ];
    showDialogWithOptions(
      "DuÅ¼a roÅ›lina doniczkowa w brÄ…zowej doniczce.",
      options
    );
  }

  examineSofa() {
    const options = [
      {
        text: "SprawdÅº poduszki",
        action: () => {
          if (!this.searchedPlaces.sofa) {
            this.searchedPlaces.sofa = true;
            addItem("Stare monety");
            showDialog(
              "Pod poduszkami znalazÅ‚eÅ› kilka starych monet i guzik. Monety dodane do ekwipunku."
            );
          } else {
            showDialog("JuÅ¼ sprawdziÅ‚eÅ› poduszki. Nic wiÄ™cej tam nie ma.");
          }
        }
      },
      {
        text: "SprawdÅº pod sofÄ…",
        action: () => {
          if (hasItem("Kartka z sejfu")) {
            if (!gameState.suitcaseFound) {
              gameState.suitcaseFound = true;
              this.showSuitcasePopup(); // ZMIANA: pokaÅ¼ popup zamiast od razu dodawaÄ‡ do ekwipunku
            } else {
              showDialog("JuÅ¼ znalazÅ‚eÅ› walizkÄ™ pod sofÄ….");
            }
          } else {
            showDialog(
              "Pod sofÄ… jest tylko kurz i pajÄ™czyny. MoÅ¼e potrzebujÄ™ wskazÃ³wki gdzie szukaÄ‡?"
            );
          }
        }
      }
    ];
    showDialogWithOptions(
      "Wygodna, stara sofa w brÄ…zowym kolorze. Obicie jest miejscami wytarte.",
      options
    );
  }

  examineLamp() {
    const options = [
      {
        text: "SprawdÅº Å¼arÃ³wkÄ™",
        action: () => {
          showDialog(
            "Stara Å¼arÃ³wka wciÄ…Å¼ Å›wieci ciepÅ‚ym Å›wiatÅ‚em. Marka 'Tungsram' - wÄ™gierska produkcja."
          );
        }
      },
      {
        text: "SprawdÅº przewÃ³d",
        action: () => {
          showDialog(
            "Stary przewÃ³d w materiaÅ‚owej osÅ‚onie. Typowy dla lat 70-tych."
          );
        }
      }
    ];
    showDialogWithOptions("Å»Ã³Å‚ta lampa wiszÄ…ca w stylu lat 70-tych.", options);
  }

  examineWindow() {
    const options = [
      {
        text: "SprawdÅº parapet",
        action: () => {
          showDialog(
            "Na parapecie leÅ¼Ä… stare gazety z 2013 roku i zwiÄ™dÅ‚y kwiat w szklanym sÅ‚oiku."
          );
        }
      },
      {
        text: "Spojrz przez okno",
        action: () => {
          showDialog(
            "Przez okno widaÄ‡ deszczowe podwÃ³rko gdzie byÅ‚eÅ› wczeÅ›niej. Deszcz wciÄ…Å¼ pada."
          );
        }
      }
    ];
    showDialogWithOptions(
      "Okno z kremowymi firankami. WidaÄ‡ przez nie podwÃ³rko.",
      options
    );
  }

  render() {
    if (gameState.tvScreenOn) {
      // PokaÅ¼ obraz TV jako tÅ‚o
      const tvImg = preloadImages.tvScreen;
      if (tvImg.complete) {
        ctx.drawImage(tvImg, 0, 0, 800, 600);
      } else {
        // fallback jeÅ›li obraz siÄ™ nie zaÅ‚adowaÅ‚
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, 800, 600);
      }
    } else {
      // Normalne mieszkanie
      const img = new Image();
      img.src = "https://i.imgur.com/CcmvRTN.jpeg";
      if (img.complete) {
        ctx.drawImage(img, 0, 0, 800, 600);
      } else {
        // fallback
        ctx.fillStyle = "#8B4513";
        ctx.fillRect(0, 0, 800, 600);
        ctx.fillStyle = "#ffffff";
        ctx.font = "20px Georgia";
        ctx.textAlign = "center";
        ctx.fillText("Mieszkanie Starzika", 400, 300);
        ctx.fillText("(Åadowanie zdjÄ™cia...)", 400, 330);
      }
    }

    // AKTUALIZUJ I NARYSUJ SUBTELNY DESZCZ
    this.updateRain();
    this.drawRain();

    // Dodaj lekkie przyciemnienie dla klimatu
    ctx.fillStyle = "rgba(20, 20, 30, 0.1)";
    ctx.fillRect(0, 0, 800, 600);
  }
  showHiddenPicture() {
    const hiddenPictureContent = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
        <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
        
        <img src="https://i.imgur.com/IDnZ13x.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="Ukryty obraz z kodem">
        <div style="text-align: center; margin-top: 15px; color: #fff; font-size: 18px; font-weight: bold;">
          Kod: 2710
        </div>
      </div>
    `;
    showDialog(hiddenPictureContent, 0);
  }

  showSafePopup() {
    const safeContent = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
        <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
        
        <img src="https://i.imgur.com/u3pO09J.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="Sejf">
        <div style="text-align: center; margin-top: 15px;">
          <input type="text" id="safeCodeInput" placeholder="WprowadÅº kod" maxlength="5" style="padding: 10px; font-size: 16px; text-align: center; border: 2px solid #666; border-radius: 5px; background: #333; color: #fff; margin: 10px;">
          <br>
          <button onclick="window.checkSafeCode()" style="padding: 10px 20px; background: #4a5568; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">SPRAWDÅ¹ KOD</button>
        </div>
      </div>
    `;

    const self = this;
    window.checkSafeCode = () => {
      const code = document.getElementById("safeCodeInput").value;
      if (code === "23218") {
        gameState.safeOpened = true;
        addItem("Kartka z sejfu");
        hideDialog();
        showDialog("Sejf siÄ™ otworzyÅ‚! ZnalazÅ‚eÅ› kartkÄ™ z wskazÃ³wkÄ…!");
      } else {
        showDialog("NieprawidÅ‚owy kod do sejfu!", 2000);
      }
    };

    showDialog(safeContent, 0);
  }

  showTVScreen() {
    // Tylko zmieÅ„ tÅ‚o, bez popup
    gameState.tvScreenOn = true;
    hideDialog(); // Zamknij menu TV
  }
  showSuitcasePopup() {
    const suitcaseContent = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
      <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
      
      <img src="https://i.imgur.com/gT3o9yo.png" style="max-width: 90vw; max-height: 70vh; display: block;" alt="Walizka">
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="window.takeSuitcase()" style="padding: 10px 20px; background: #4a5568; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px;">WEÅ¹ WALIZKÄ˜</button>
      </div>
    </div>
  `;

    window.takeSuitcase = () => {
      addItem("Walizka");
      hideDialog();
      showDialog("ZnalazÅ‚eÅ› starÄ… walizkÄ™! Dodana do ekwipunku.");
    };

    showDialog(suitcaseContent, 0);
  }
  showTVCodePopup() {
    const codePopup = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 2px solid #555;">
        <button onclick="hideDialog()" style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">Ã—</button>
        
        <div style="text-align: center; color: #fff; font-size: 18px; padding: 15px;">
          <strong>Nr seryjny: I-2 II-1 III-8 IV-6 V-5</strong>
        </div>
      </div>
    `;
    showDialog(codePopup, 0);
  }
}

class EndingScene extends Scene {
  constructor() {
    super();
    this.alpha = 0;
    this.addArea(0, 0, 800, 600, () => {
      changeScene("menu");
      inventory = [];
      gameState = {
        hasSpade: false,
        hasBone: false,
        boneVisible: false,
        gaveBone: false,
        gotInfoFromKowalski: false,
        askedAboutWindows: false,
        wellOpened: false,
        hasID: false,
        hasSmallKey: false,
        gotLetter: false,
        askedAboutIntercomCode: false,
        readLetter: false,
        canEnter: false,
        intercomUnlocked: false,
        fuseBoxSolved: false,
        searchedWycieraczka: false,
        searchedStroller: false,
        foundSafeCard: false,
        safeOpened: false,
        tvTurnedOn: false,
        suitcaseFound: false,
        tvScreenOn: false,
        cabinetOpened: false
      };
      updateInventoryDisplay();
      this.alpha = 0;
    });
  }

  render() {
    const gradient = ctx.createLinearGradient(0, 0, 0, 600);
    gradient.addColorStop(0, "#4a4a6a");
    gradient.addColorStop(1, "#2a2a4a");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 800, 600);

    this.alpha += 0.01;
    if (this.alpha > 1) this.alpha = 1;

    if (this.alpha > 0.8) {
      ctx.fillStyle =
        "rgba(255, 255, 255, " + Math.min(1, (this.alpha - 0.8) * 5) + ")";
      ctx.font = "24px Georgia";
      ctx.textAlign = "center";
      ctx.fillText("Starzik wyrusza w podrÃ³Å¼...", 400, 500);

      ctx.font = "16px Georgia";
      ctx.fillText("Co zostaÅ‚o w jego mieszkaniu?", 400, 530);
      ctx.fillText("Przekonaj siÄ™ w escape roomie Familock!", 400, 550);
    }

    if (this.hoveredArea) {
      ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
      ctx.fillRect(
        this.hoveredArea.x,
        this.hoveredArea.y,
        this.hoveredArea.w,
        this.hoveredArea.h
      );
    }
  }
}
function toggleFullscreenGlobal() {
  try {
    if (!document.fullscreenElement) {
      // WejdÅº w peÅ‚ny ekran
      const gameContainer =
        document.querySelector(".game-container") || document.body;
      if (gameContainer.requestFullscreen) {
        gameContainer.requestFullscreen();
      } else if (gameContainer.webkitRequestFullscreen) {
        gameContainer.webkitRequestFullscreen();
      } else if (gameContainer.msRequestFullscreen) {
        gameContainer.msRequestFullscreen();
      }
      showDialog(
        "Gra uruchomiona na peÅ‚nym ekranie! NaciÅ›nij ESC aby wyjÅ›Ä‡.",
        2000
      );
    } else {
      // WyjdÅº z peÅ‚nego ekranu
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      showDialog("WyszedÅ‚eÅ› z peÅ‚nego ekranu.", 2000);
    }
  } catch (error) {
    showDialog("PrzeglÄ…darka nie obsÅ‚uguje peÅ‚nego ekranu.", 2000);
    console.log("Fullscreen error:", error);
  }
}

// Ukryj/pokaÅ¼ ikonÄ™ w zaleÅ¼noÅ›ci od sceny
function updateFullscreenIcon() {
  const icon = document.getElementById("fullscreenIcon");
  if (icon) {
    // Ukryj w menu, pokaÅ¼ w grze
    icon.style.display = currentScene === "menu" ? "none" : "flex";
  }
}
function showCreditsScreen() {
  hideDialog();

  const creditsContent = `
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(20, 22, 34, 0.95); z-index: 10001; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
      <div style="background: #F5F1E8; color: #2C1810; padding: 40px; border-radius: 10px; border: 2px solid #D4C4A8; text-align: center; max-width: 600px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); margin: 20px;">
        
        <div style="font-size: 28px; margin-bottom: 10px; font-weight: bold; font-family: serif; color: #2C1810;">
          Starzik: TheSzpil
        </div>
        <div style="font-size: 16px; margin-bottom: 20px; font-style: italic; color: #666;">
          || wersja beta ||<br/>
          ÅšwiÄ™tochÅ‚owice 2025
        </div>
        
        <div style="width: 80%; height: 1px; background: #8B4513; margin: 20px auto;"></div>
        
        <div style="font-size: 16px; margin: 20px 0; line-height: 1.6; font-family: serif;">
          Gra promocyjna escape roomu Familock w ÅšwiÄ™tochÅ‚owicach.<br/>
          <strong>Zarezerwuj swojÄ… grÄ™ na www.familock.pl</strong>
        </div>
        
        <div style="width: 80%; height: 1px; background: #8B4513; margin: 20px auto;"></div>
        
        <div style="font-size: 14px; margin: 20px 0; line-height: 1.8; font-family: serif; text-align: left;">
          <strong>TwÃ³rcy:</strong><br/>
          PomysÅ‚: Åukasz DyÅ‚ka<br/>
          Grafika: Chat GPT<br/>
          Kod: Claude.ai<br/>
          Logika, pomysÅ‚ zagadek: Åukasz DyÅ‚ka<br/>
          Muzyka, dÅºwiÄ™ki: Pixabay.com, Elevenlabs.com
        </div>
        
        <div style="width: 80%; height: 1px; background: #8B4513; margin: 20px auto;"></div>
        
        <div style="font-size: 14px; margin: 20px 0; line-height: 1.6; font-family: serif;">
          Gra moÅ¼e siÄ™ rozwijaÄ‡ i w kaÅ¼dym momencie moÅ¼e wyjÅ›Ä‡ aktualizacja o nowe lokacje i zagadki.<br/><br/>
          <strong>Wesprzyj tworzenie gry:</strong><br/>
          <a href="https://buycoffee.to/wspolnotafamilocka" target="_blank" style="color: #8b4513; text-decoration: underline;">https://buycoffee.to/wspolnotafamilocka</a>
        </div>
        
        <div style="width: 80%; height: 1px; background: #8B4513; margin: 20px auto;"></div>
        
        <div style="margin-top: 30px;">
          <button onclick="showDiscountCode()" style="padding: 15px 25px; background: #d4af37; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 10px; font-family: serif;">
            ODBIERZ KOD ZNIÅ»KOWY
          </button><br/>
          <button onclick="changeScene('menu'); hideDialog()" style="padding: 10px 20px; background: #8b4513; color: #fff; border: 2px solid #5d2f0a; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; font-family: serif;">
            MENU GÅÃ“WNE
          </button>
        </div>
      </div>
    </div>
  `;
  showDialog(creditsContent, 0);
}
// System kodÃ³w rabatowych - jeden kod na komputer
const discountCodes = [
  "STARZIK-A1B2",
  "STARZIK-C3D4",
  "STARZIK-E5F6",
  "STARZIK-G7H8",
  "STARZIK-I9J0",
  "STARZIK-K1L2",
  "STARZIK-M3N4",
  "STARZIK-O5P6",
  "STARZIK-Q7R8",
  "STARZIK-S9T0",
  "STARZIK-U1V2",
  "STARZIK-W3X4",
  "STARZIK-Y5Z6",
  "STARZIK-A7B8",
  "STARZIK-C9D0"
];
// DODAJ TÄ˜ FUNKCJÄ˜ TUTAJ NA POCZÄ„TKU
function checkCodesStatus() {
  const usedCodes = JSON.parse(
    localStorage.getItem("starzikUsedCodes") || "{}"
  );
  const usedCount = Object.keys(usedCodes).length;
  const availableCount = discountCodes.length - usedCount;

  console.log(`Kody wykorzystane: ${usedCount}/${discountCodes.length}`);
  console.log(`Kody dostÄ™pne: ${availableCount}`);
  console.log("SzczegÃ³Å‚y:", usedCodes);

  return {
    total: discountCodes.length,
    used: usedCount,
    available: availableCount,
    details: usedCodes
  };
}

// DODAJ TAKÅ»E RESET NA POCZÄ„TKU
function resetDiscountCodes() {
  localStorage.removeItem("starzikUsedCodes");
  console.log("Kody rabatowe zostaÅ‚y zresetowane");
}
function getComputerFingerprint() {
  // Generuj unikalny "odcisk palca" komputera
  const screen = `${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`;
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const language = navigator.language;
  const platform = navigator.platform;
  const userAgent = navigator.userAgent.slice(0, 50); // SkrÃ³cona wersja

  const fingerprint = `${screen}-${timezone}-${language}-${platform}-${userAgent}`;

  // StwÃ³rz hash z odcisku palca
  let hash = 0;
  for (let i = 0; i < fingerprint.length; i++) {
    const char = fingerprint.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash; // Konwertuj na 32-bit integer
  }

  return `comp_${Math.abs(hash)}`;
}

function getUsedCodes() {
  return JSON.parse(localStorage.getItem("starzikUsedCodes") || "{}");
}

function markCodeAsUsed(computerId, code) {
  const usedCodes = getUsedCodes();
  usedCodes[computerId] = {
    code: code,
    timestamp: new Date().toISOString(),
    used: true
  };
  localStorage.setItem("starzikUsedCodes", JSON.stringify(usedCodes));
}

function getCodeForComputer(computerId) {
  const usedCodes = getUsedCodes();

  // SprawdÅº czy ten komputer juÅ¼ ma przypisany kod
  if (usedCodes[computerId]) {
    return usedCodes[computerId].code;
  }

  // ZnajdÅº pierwszy niewykorzystany kod
  const usedCodesList = Object.values(usedCodes).map((entry) => entry.code);
  const availableCode = discountCodes.find(
    (code) => !usedCodesList.includes(code)
  );

  if (availableCode) {
    markCodeAsUsed(computerId, availableCode);
    return availableCode;
  }

  return null; // Brak dostÄ™pnych kodÃ³w
}

function showDiscountCode() {
  const computerId = getComputerFingerprint();
  const code = getCodeForComputer(computerId);

  if (code) {
    const codeContent = `
      <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(20, 22, 34, 0.95); z-index: 10002; display: flex; align-items: center; justify-content: center;">
        <div style="background: #F5F1E8; color: #2C1810; padding: 40px; border-radius: 10px; border: 3px solid #d4af37; text-align: center; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
          
          <div style="font-size: 24px; margin-bottom: 20px; font-weight: bold; font-family: serif; color: #2C1810;">
            Super, Å¼e dotarÅ‚eÅ› do tego miejsca!
          </div>
          
          <div style="font-size: 16px; margin: 20px 0; line-height: 1.6; font-family: serif;">
            Oto kod na <strong>20 zÅ‚ zniÅ¼ki</strong> do escape roomu Starzik.<br/>
            Wpisz go podczas rezerwacji.
          </div>
          
          <div style="background: #fff; border: 3px dashed #d4af37; padding: 20px; margin: 20px 0; border-radius: 10px;">
            <div style="font-size: 28px; font-weight: bold; color: #8b4513; font-family: monospace;">
              ${code}
            </div>
          </div>
          
          <div style="font-size: 14px; margin: 10px 0; color: #666; font-style: italic;">
            Ten kod jest przypisany do tego komputera
          </div>
          
          <div style="font-size: 18px; margin: 20px 0; font-weight: bold; color: #8b4513; font-family: serif;">
            DziÄ™ki!
          </div>
          
          <button onclick="changeScene('menu'); hideDialog()" style="padding: 15px 25px; background: #8b4513; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px; font-family: serif;">
            ZAMKNIJ
          </button>
        </div>
      </div>
    `;
    showDialog(codeContent, 0);
  } else {
    showDialog(
      "Niestety, wszystkie kody zostaÅ‚y juÅ¼ wykorzystane. SprÃ³buj pÃ³Åºniej!",
      3000
    );
  }
}

// Funkcja resetowania kodÃ³w (dla administratora)
function resetDiscountCodes() {
  localStorage.removeItem("starzikUsedCodes");
  console.log("Kody rabatowe zostaÅ‚y zresetowane");
}

// Funkcja do sprawdzenia stanu kodÃ³w (dla administratora)
function checkCodesStatus() {
  const usedCodes = getUsedCodes();
  const usedCount = Object.keys(usedCodes).length;
  const availableCount = discountCodes.length - usedCount;

  console.log(`Kody wykorzystane: ${usedCount}/${discountCodes.length}`);
  console.log(`Kody dostÄ™pne: ${availableCount}`);
  console.log("SzczegÃ³Å‚y:", usedCodes);

  return {
    total: discountCodes.length,
    used: usedCount,
    available: availableCount,
    details: usedCodes
  };
}
function gameLoop() {
  try {
    if (!ctx || !canvas) {
      console.error("Canvas or context not available!");
      return;
    }

    ctx.clearRect(0, 0, 800, 600);

    if (scenes && scenes[currentScene] && scenes[currentScene].render) {
      scenes[currentScene].render();
    } else {
      console.error("Scene not found:", currentScene);
      ctx.fillStyle = "#ff0000";
      ctx.fillRect(100, 100, 200, 100);
      ctx.fillStyle = "#ffffff";
      ctx.font = "20px Arial";
      ctx.fillText("Error: Scene not found", 110, 150);
    }

    requestAnimationFrame(gameLoop);
  } catch (error) {
    console.error("Error in gameLoop:", error);
    log("âŒ BÅ‚Ä…d w gameLoop: " + error.message);
    setTimeout(() => {
      requestAnimationFrame(gameLoop);
    }, 1000);
  }
}
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM loaded, starting game initialization...");
  setTimeout(() => {
    try {
      const result = initGame();
      if (result) {
        log("ğŸ‰ Gra zaÅ‚adowana!");
        console.log("Game started successfully!");
      } else {
        log("âŒ BÅ‚Ä…d Å‚adowania gry");
        console.error("Game failed to start");
      }
    } catch (error) {
      console.error("Critical error:", error);
      log("âŒ Krytyczny bÅ‚Ä…d: " + error.message);
    }
  }, 100);
});
document.addEventListener("keydown", function (e) {
  if (e.ctrlKey && e.shiftKey && e.key === "F") {
    // Tworzymy popup
    const popup = document.createElement("div");
    popup.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            text-align: center;
            font-family: Georgia, serif;
            border: 3px solid gold;
            animation: popupAppear 0.5s ease-out;
        `;

    popup.innerHTML = `
            <div style="font-size: 24px; margin-bottom: 15px;">ODKRYÅEÅš SEKRET FAMILOCKA!</div>
            <div style="font-size: 18px; margin-bottom: 20px; color: #FFD700; font-weight: bold;">
                Kod rabatowy: STARZIK2025
            </div>
            <div style="font-size: 14px; margin-bottom: 20px;">
                UÅ¼yj tego kodu na www.familock.pl przy rezerwacji!
            </div>
            <button onclick="this.parentElement.remove()" style="
                background: gold;
                color: black;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
            ">ZAMKNIJ</button>
        `;

    // Dodaj animacjÄ™ CSS
    const style = document.createElement("style");
    style.textContent = `
            @keyframes popupAppear {
                0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
        `;
    document.head.appendChild(style);

    document.body.appendChild(popup);

    // Automatycznie usuÅ„ po 10 sekundach
    setTimeout(() => {
      if (popup.parentElement) {
        popup.remove();
      }
    }, 10000);
  }
});
